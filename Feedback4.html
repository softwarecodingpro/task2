<!DOCTYPE html>
<!-- saved from url=(0069)https://feedback.anthropic.com/pr_writer_v2_feedback?email_login=true -->
<html class="h-full antialiased" lang="en" style=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="./Feedback4_files/dca91451eef0c376.css" data-precedence="next"><link rel="stylesheet" href="./Feedback4_files/0f068b0701fbff89.css" data-precedence="next"><link rel="stylesheet" href="./Feedback4_files/ebea8208b939091a.css" data-precedence="next"><link rel="preload" as="script" fetchpriority="low" href="./Feedback4_files/webpack-02a3309d8cf7dbe3.js.download"><script src="./Feedback4_files/fd9d1056-20188ba3346e98eb.js.download" async=""></script><script src="./Feedback4_files/96-424058785483deb0.js.download" async=""></script><script src="./Feedback4_files/main-app-2f42c52a88988879.js.download" async=""></script><script src="./Feedback4_files/9700-cd1b84436b00714b.js.download" async=""></script><script src="./Feedback4_files/9737-68e0d6906068f80b.js.download" async=""></script><script src="./Feedback4_files/306-96a96916493718f6.js.download" async=""></script><script src="./Feedback4_files/4432-af9f3e53a0ca3ce2.js.download" async=""></script><script src="./Feedback4_files/6619-63a34dce41617ed0.js.download" async=""></script><script src="./Feedback4_files/1320-1e443f717bacab2f.js.download" async=""></script><script src="./Feedback4_files/5089-bd8c0f1adb097f75.js.download" async=""></script><script src="./Feedback4_files/7070-7087d6d4c2b31bdb.js.download" async=""></script><script src="./Feedback4_files/7292-4e4d4deadf3ded36.js.download" async=""></script><script src="./Feedback4_files/4690-a6bb3c67988e8aa9.js.download" async=""></script><script src="./Feedback4_files/error-40b65e1758631991.js.download" async=""></script><script src="./Feedback4_files/1396-dab8694f261b5630.js.download" async=""></script><script src="./Feedback4_files/not-found-46ac9ad64a862c71.js.download" async=""></script><script src="./Feedback4_files/d3ac728e-bb9497487093df3c.js.download" async=""></script><script src="./Feedback4_files/c16f53c3-31b7f93f24aa8d3b.js.download" async=""></script><script src="./Feedback4_files/93854f56-ab5ea3b6d9bdc4d5.js.download" async=""></script><script src="./Feedback4_files/97bfd92e-7f35d0c7d41cf231.js.download" async=""></script><script src="./Feedback4_files/6935-8535a2a6bfd298f0.js.download" async=""></script><script src="./Feedback4_files/6944-654282aea6a1ac2a.js.download" async=""></script><script src="./Feedback4_files/724-4aa0cf3c8e37113e.js.download" async=""></script><script src="./Feedback4_files/3760-9010a99bf1e389c3.js.download" async=""></script><script src="./Feedback4_files/4959-ae7510f0a6c532d6.js.download" async=""></script><script src="./Feedback4_files/8276-8b1dc22a562b476f.js.download" async=""></script><script src="./Feedback4_files/1667-dae9a6bfeaa45cf6.js.download" async=""></script><script src="./Feedback4_files/4357-d31108392e660f54.js.download" async=""></script><script src="./Feedback4_files/6698-297fb2c945e71ff8.js.download" async=""></script><script src="./Feedback4_files/3584-f51c4006cfc91e88.js.download" async=""></script><script src="./Feedback4_files/1975-993abf981611aa6a.js.download" async=""></script><script src="./Feedback4_files/49-1d7e6afd50c8d660.js.download" async=""></script><script src="./Feedback4_files/3040-07b67600cc132fbe.js.download" async=""></script><script src="./Feedback4_files/9519-c194b48d9bf3448f.js.download" async=""></script><script src="./Feedback4_files/2395-6d74a371291c4cb9.js.download" async=""></script><script src="./Feedback4_files/6331-ec16a7d7d97ac18c.js.download" async=""></script><script src="./Feedback4_files/9936-c9314376abfc8148.js.download" async=""></script><script src="./Feedback4_files/9803-c6dc0df0d63bbda9.js.download" async=""></script><script src="./Feedback4_files/page-d01e7e0cb902d9fb.js.download" async=""></script><link rel="preload" href="./Feedback4_files/js" as="script"><title>Feedback</title><meta name="description" content="Feedback App"><script src="./Feedback4_files/polyfills-c67a75d1b6f99dc8.js.download" nomodule=""></script><style data-emotion="css" data-s=""></style></head><body class="h-full bg-white"><script src="./Feedback4_files/webpack-02a3309d8cf7dbe3.js.download" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/css/dca91451eef0c376.css\",\"style\"]\n0:\"$L2\"\n"])</script><script>self.__next_f.push([1,"3:HL[\"/_next/static/css/0f068b0701fbff89.css\",\"style\"]\n4:HL[\"/_next/static/css/ebea8208b939091a.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"5:I[33728,[],\"\"]\n7:I[29928,[],\"\"]\n"])</script><script>self.__next_f.push([1,"8:I[38528,[\"9700\",\"static/chunks/9700-cd1b84436b00714b.js\",\"9737\",\"static/chunks/9737-68e0d6906068f80b.js\",\"306\",\"static/chunks/306-96a96916493718f6.js\",\"4432\",\"static/chunks/4432-af9f3e53a0ca3ce2.js\",\"6619\",\"static/chunks/6619-63a34dce41617ed0.js\",\"1320\",\"static/chunks/1320-1e443f717bacab2f.js\",\"5089\",\"static/chunks/5089-bd8c0f1adb097f75.js\",\"7070\",\"static/chunks/7070-7087d6d4c2b31bdb.js\",\"7292\",\"static/chunks/7292-4e4d4deadf3ded36.js\",\"4690\",\"static/chunks/4690-a6bb3c67988e8aa9.js\",\"6211\",\"static/chunks/6211-cf16e4e93f7bd3a2.js\",\"3185\",\"static/chunks/app/layout-7623eba701dddf00.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"9:I[20905,[\"9700\",\"static/chunks/9700-cd1b84436b00714b.js\",\"9737\",\"static/chunks/9737-68e0d6906068f80b.js\",\"306\",\"static/chunks/306-96a96916493718f6.js\",\"4432\",\"static/chunks/4432-af9f3e53a0ca3ce2.js\",\"6619\",\"static/chunks/6619-63a34dce41617ed0.js\",\"1320\",\"static/chunks/1320-1e443f717bacab2f.js\",\"5089\",\"static/chunks/5089-bd8c0f1adb097f75.js\",\"7070\",\"static/chunks/7070-7087d6d4c2b31bdb.js\",\"7292\",\"static/chunks/7292-4e4d4deadf3ded36.js\",\"4690\",\"static/chunks/4690-a6bb3c67988e8aa9.js\",\"6211\",\"static/chunks/6211-cf16e4e93f7bd3a2.js\",\"3185\",\"static/chunks/app/layout-7623eba701dddf00.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"a:I[56954,[],\"\"]\nb:I[2312,[\"7601\",\"static/chunks/app/error-40b65e1758631991.js\"],\"\"]\nc:I[7264,[],\"\"]\nd:I[48516,[\"1396\",\"static/chunks/1396-dab8694f261b5630.js\",\"9160\",\"static/chunks/app/not-found-46ac9ad64a862c71.js\"],\"\"]\nf:I[48297,[],\"\"]\n"])</script><script>self.__next_f.push([1,"10:I[66123,[\"3954\",\"static/chunks/d3ac728e-bb9497487093df3c.js\",\"5501\",\"static/chunks/c16f53c3-31b7f93f24aa8d3b.js\",\"9982\",\"static/chunks/93854f56-ab5ea3b6d9bdc4d5.js\",\"7732\",\"static/chunks/97bfd92e-7f35d0c7d41cf231.js\",\"9700\",\"static/chunks/9700-cd1b84436b00714b.js\",\"9737\",\"static/chunks/9737-68e0d6906068f80b.js\",\"306\",\"static/chunks/306-96a96916493718f6.js\",\"1396\",\"static/chunks/1396-dab8694f261b5630.js\",\"4432\",\"static/chunks/4432-af9f3e53a0ca3ce2.js\",\"6619\",\"static/chunks/6619-63a34dce41617ed0.js\",\"1320\",\"static/chunks/1320-1e443f717bacab2f.js\",\"5089\",\"static/chunks/5089-bd8c0f1adb097f75.js\",\"6935\",\"static/chunks/6935-8535a2a6bfd298f0.js\",\"6944\",\"static/chunks/6944-654282aea6a1ac2a.js\",\"724\",\"static/chunks/724-4aa0cf3c8e37113e.js\",\"3760\",\"static/chunks/3760-9010a99bf1e389c3.js\",\"4959\",\"static/chunks/4959-ae7510f0a6c532d6.js\",\"8276\",\"static/chunks/8276-8b1dc22a562b476f.js\",\"1667\",\"static/chunks/1667-dae9a6bfeaa45cf6.js\",\"4357\",\"static/chunks/4357-d31108392e660f54.js\",\"6698\",\"static/chunks/6698-297fb2c945e71ff8.js\",\"3584\",\"static/chunks/3584-f51c4006cfc91e88.js\",\"1975\",\"static/chunks/1975-993abf981611aa6a.js\",\"49\",\"static/chunks/49-1d7e6afd50c8d660.js\",\"3040\",\"static/chunks/3040-07b67600cc132fbe.js\",\"9519\",\"static/chunks/9519-c194b48d9bf3448f.js\",\"2395\",\"static/chunks/2395-6d74a371291c4cb9.js\",\"6211\",\"static/chunks/6211-cf16e4e93f7bd3a2.js\",\"6331\",\"static/chunks/6331-ec16a7d7d97ac18c.js\",\"56\",\"static/chunks/56-6d1df7e7683324ae.js\",\"9936\",\"static/chunks/9936-c9314376abfc8148.js\",\"9803\",\"static/chunks/9803-c6dc0df0d63bbda9.js\",\"6245\",\"static/chunks/6245-6c4a6bf7d2f316fd.js\",\"5261\",\"static/chunks/app/%5B...interfaceSlug%5D/page-d01e7e0cb902d9fb.js\"],\"\"]\n"])</script><script>self.__next_f.push([1,"2:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/dca91451eef0c376.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L5\",null,{\"buildId\":\"3JwAEJ0057nvcoG8oeOfb\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/pr_writer_v2_feedback?email_login=true\",\"initialTree\":[\"\",{\"children\":[[\"interfaceSlug\",\"pr_writer_v2_feedback\",\"c\"],{\"children\":[\"__PAGE__?{\\\"email_login\\\":\\\"true\\\"}\",{}]}]},\"$undefined\",\"$undefined\",true],\"initialHead\":[false,\"$L6\"],\"globalErrorComponent\":\"$7\",\"children\":[null,[\"$\",\"html\",null,{\"className\":\"h-full antialiased\",\"lang\":\"en\",\"children\":[\"$\",\"body\",null,{\"className\":\"h-full bg-white\",\"children\":[\"$\",\"$L8\",null,{\"children\":[\"$\",\"$L9\",null,{\"children\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$b\",\"errorStyles\":[],\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":[\"$\",\"$Ld\",null,{}],\"notFoundStyles\":[],\"childProp\":{\"current\":[\"$\",\"$La\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",[\"interfaceSlug\",\"pr_writer_v2_feedback\",\"c\"],\"children\"],\"loading\":\"$undefined\",\"loadingStyles\":\"$undefined\",\"hasLoading\":false,\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"template\":[\"$\",\"$Lc\",null,{}],\"templateStyles\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"childProp\":{\"current\":[\"$Le\",[\"$\",\"$Lf\",null,{\"propsForComponent\":{\"params\":{\"interfaceSlug\":[\"pr_writer_v2_feedback\"]},\"searchParams\":{\"email_login\":\"true\"}},\"Component\":\"$10\",\"isStaticGeneration\":false}],null],\"segment\":\"__PAGE__?{\\\"email_login\\\":\\\"true\\\"}\"},\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/0f068b0701fbff89.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/ebea8208b939091a.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],\"segment\":[\"interfaceSlug\",\"pr_writer_v2_feedback\",\"c\"]},\"styles\":[]}]}]}]}]}],null]}]]\n"])</script><script>self.__next_f.push([1,"6:[[\"$\",\"meta\",\"0\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"1\",{\"children\":\"Feedback\"}],[\"$\",\"meta\",\"2\",{\"name\":\"description\",\"content\":\"Feedback App\"}],[\"$\",\"meta\",\"3\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}]]\ne:null\n"])</script><script src="./Feedback4_files/js" async="true" data-nscript="afterInteractive"></script><script id="google-analytics" data-nscript="afterInteractive">window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-CL7K14J54N');</script><next-route-announcer style="position: absolute;"><template shadowrootmode="open"><div aria-live="assertive" id="__next-route-announcer__" role="alert" style="position: absolute; border: 0px; height: 1px; margin: -1px; padding: 0px; width: 1px; clip: rect(0px, 0px, 0px, 0px); overflow: hidden; white-space: nowrap; overflow-wrap: normal;"></div></template></next-route-announcer><div class="h-full flex flex-col relative"><div class="Toastify"></div><div class="bg-gray-50 border-b border-gray-200"><div class="flex flex-row navbar mx-auto px-0 h-8"><div class="grow"><div class="px-4 py-1 text-lg font-medium rounded-md">PR Writing in Python</div></div><div class="flex-none inline-flex gap-2 px-4"><div><div class=""><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] " aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-indigo-600"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div><div><div class="" data-tip=""><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] " aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-600"><path fill-rule="evenodd" d="M17.663 3.118c.225.015.45.032.673.05C19.876 3.298 21 4.604 21 6.109v9.642a3 3 0 0 1-3 3V16.5c0-5.922-4.576-10.775-10.384-11.217.324-1.132 1.3-2.01 2.548-2.114.224-.019.448-.036.673-.051A3 3 0 0 1 13.5 1.5H15a3 3 0 0 1 2.663 1.618ZM12 4.5A1.5 1.5 0 0 1 13.5 3H15a1.5 1.5 0 0 1 1.5 1.5H12Z" clip-rule="evenodd"></path><path d="M3 8.625c0-1.036.84-1.875 1.875-1.875h.375A3.75 3.75 0 0 1 9 10.5v1.875c0 1.036.84 1.875 1.875 1.875h1.875A3.75 3.75 0 0 1 16.5 18v2.625c0 1.035-.84 1.875-1.875 1.875h-9.75A1.875 1.875 0 0 1 3 20.625v-12Z"></path><path d="M10.5 10.5a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963 5.23 5.23 0 0 0-3.434-1.279h-1.875a.375.375 0 0 1-.375-.375V10.5Z"></path></svg></button></div></div><div class="relative inline-block text-left" data-headlessui-state=""><button class="inline-flex justify-center items-center px-2 py-2 font-medium text-gray-500 rounded-md hover:bg-gray-600/[.15] hover:text-gray-700 " id="headlessui-menu-button-:r8:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 20 20" aria-hidden="true" class="w-5 h-5" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M6 10a2 2 0 11-4 0 2 2 0 014 0zM12 10a2 2 0 11-4 0 2 2 0 014 0zM16 12a2 2 0 100-4 2 2 0 000 4z"></path></svg></button></div></div></div></div><div class="h-full w-full"><div class="w-full h-full"><div class="flex flex-col grow content-between w-full mx-auto pb-8"><div class="flex flex-col py-6 px-4 max-w-3xl mx-auto w-full"><div class="w-full flex justify-between"><div class="grow"></div></div><div class="flow-root pb-6" data-testid="conversation-pane"><ul><li class="px-3 pt-3 "><div class="relative"><div class="relative flex space-x-3"><span class="css-v87e6z">ðŸ§‘</span><div class="flex-col w-full"><p class="text-sm"><span class="font-medium capitalize flex text-gray-900">Human</span></p><div class="text-sm text-gray-500 w-full flex flex-row"><div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4"><div class="w-full"><div class="whitespace-pre-wrap">Update the PocketFlow library to include native FastAPI integration.

Add a mount_flow() helper that:
Automatically registers /run, /stream, /metrics, and /health routes
Supports both Flow and AsyncFlow
Optionally enables streaming and metrics
Handles errors cleanly
Keeps full backward compatibility
Do not modify existing Flow/Node behavior. Only extend the library.

Return clean, production-ready code.</div></div></div></div><div class="flex-row w-full overflow-x-auto"><div class="flex-row w-full overflow-x-auto"><div class="flex flex-col my-4"><span class="flex justify-center"><div class="w-full"><div class="inline-flex gap-x-2 p-2 items-center rounded border border-gray-200"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 20 20" aria-hidden="true" class="text-gray-400" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path></svg><div class="text-xs font-medium text-gray-600">PocketFlow/</div></div></div></span></div></div></div></div></div></div></li><li class="px-3 pt-3 "><div class="relative"><div class="relative flex space-x-3"><span class="css-v87e6z">ðŸ¤–</span><div class="flex-col w-full"><p class="text-sm"><span class="font-medium capitalize flex text-gray-900">assistant</span></p><div class="text-sm text-gray-500 w-full flex flex-row"><div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4"><div class="w-full"><div class="whitespace-normal"><div class="min-h-[1.50rem] space-y-1.5 w-full"><div class="flex flex-row"><div class="min-w-[96%]"><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">find /tmp/inputs/PocketFlow -type f -name "*.py" | head -20</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">/tmp/inputs/PocketFlow/setup.py
/tmp/inputs/PocketFlow/utils/update_pocketflow_mdc.py
/tmp/inputs/PocketFlow/tests/test_async_batch_flow.py
/tmp/inputs/PocketFlow/tests/test_async_batch_node.py
/tmp/inputs/PocketFlow/tests/test_async_flow.py
/tmp/inputs/PocketFlow/tests/test_async_parallel_batch_flow.py
/tmp/inputs/PocketFlow/tests/test_async_parallel_batch_node.py
/tmp/inputs/PocketFlow/tests/test_batch_flow.py
/tmp/inputs/PocketFlow/tests/test_batch_node.py
/tmp/inputs/PocketFlow/tests/test_fall_back.py
/tmp/inputs/PocketFlow/tests/test_flow_basic.py
/tmp/inputs/PocketFlow/tests/test_flow_composition.py
/tmp/inputs/PocketFlow/pocketflow/__init__.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-workflow/flow.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-workflow/main.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-workflow/nodes.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-workflow/utils/call_llm.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-voice-chat/flow.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-voice-chat/main.py
/tmp/inputs/PocketFlow/cookbook/pocketflow-voice-chat/nodes.py</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">59M	/tmp/inputs/PocketFlow
1.5K	/tmp/inputs/PocketFlow/LICENSE
18K	/tmp/inputs/PocketFlow/README.md
10M	/tmp/inputs/PocketFlow/cookbook
3.5K	/tmp/inputs/PocketFlow/cookbook/README.md
80K	/tmp/inputs/PocketFlow/cookbook/data
86K	/tmp/inputs/PocketFlow/cookbook/pocketflow-a2a
29K	/tmp/inputs/PocketFlow/cookbook/pocketflow-agent
8.5K	/tmp/inputs/PocketFlow/cookbook/pocketflow-async-basic
131K	/tmp/inputs/PocketFlow/cookbook/pocketflow-batch
1.1M	/tmp/inputs/PocketFlow/cookbook/pocketflow-batch-flow
207K	/tmp/inputs/PocketFlow/cookbook/pocketflow-batch-node
5.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-chat
9.5K	/tmp/inputs/PocketFlow/cookbook/pocketflow-chat-guardrail
21K	/tmp/inputs/PocketFlow/cookbook/pocketflow-chat-memory
14K	/tmp/inputs/PocketFlow/cookbook/pocketflow-cli-hitl
28K	/tmp/inputs/PocketFlow/cookbook/pocketflow-code-generator
6.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-communication
490K	/tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-background
483K	/tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-hitl
688K	/tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-websocket
5.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-flow
13K	/tmp/inputs/PocketFlow/cookbook/pocketflow-google-calendar
396K	/tmp/inputs/PocketFlow/cookbook/pocketflow-gradio-hitl
4.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-hello-world
6.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-llm-streaming
8.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-majority-vote
15K	/tmp/inputs/PocketFlow/cookbook/pocketflow-map-reduce
17K	/tmp/inputs/PocketFlow/cookbook/pocketflow-mcp
7.5K	/tmp/inputs/PocketFlow/cookbook/pocketflow-multi-agent
11K	/tmp/inputs/PocketFlow/cookbook/pocketflow-nested-batch
6.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-node
133K	/tmp/inputs/PocketFlow/cookbook/pocketflow-parallel-batch
1.1M	/tmp/inputs/PocketFlow/cookbook/pocketflow-parallel-batch-flow
16K	/tmp/inputs/PocketFlow/cookbook/pocketflow-rag
4.1M	/tmp/inputs/PocketFlow/cookbook/pocketflow-streamlit-fsm
12K	/tmp/inputs/PocketFlow/cookbook/pocketflow-structured-output
16K	/tmp/inputs/PocketFlow/cookbook/pocketflow-supervisor
15K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tao
58K	/tmp/inputs/PocketFlow/cookbook/pocketflow-text2sql
60K	/tmp/inputs/PocketFlow/cookbook/pocketflow-thinking
14K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tool-crawler
20K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tool-database
6.0K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tool-embeddings
328K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tool-pdf-vision
11K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tool-search
125K	/tmp/inputs/PocketFlow/cookbook/pocketflow-tracing
76K	/tmp/inputs/PocketFlow/cookbook/pocketflow-visualization
97K	/tmp/inputs/PocketFlow/cookbook/pocketflow-voice-chat
15K	/tmp/inputs/PocketFlow/cookbook/pocketflow-workflow
140K	/tmp/inputs/PocketFlow/cookbook/pocketflow_demo.ipynb
99K	/tmp/inputs/PocketFlow/docs
1.5K	/tmp/inputs/PocketFlow/docs/_config.yml
1.0K	/tmp/inputs/PocketFlow/docs/_includes
26K	/tmp/inputs/PocketFlow/docs/core_abstraction
24K	/tmp/inputs/PocketFlow/docs/design_pattern
15K	/tmp/inputs/PocketFlow/docs/guide.md
3.5K	/tmp/inputs/PocketFlow/docs/index.md
28K	/tmp/inputs/PocketFlow/docs/utility_function
11K	/tmp/inputs/PocketFlow/pocketflow
5.5K	/tmp/inputs/PocketFlow/pocketflow/__init__.py
5.0K	/tmp/inputs/PocketFlow/pocketflow/__init__.pyi
512	/tmp/inputs/PocketFlow/setup.py
70K	/tmp/inputs/PocketFlow/tests
6.5K	/tmp/inputs/PocketFlow/tests/test_async_batch_flow.py
6.5K	/tmp/inputs/PocketFlow/tests/test_async_batch_node.py
9.0K	/tmp/inputs/PocketFlow/tests/test_async_flow.py
6.0K	/tmp/inputs/PocketFlow/tests/test_async_parallel_batch_flow.py
5.0K	/tmp/inputs/PocketFlow/tests/test_async_parallel_batch_node.py
6.5K	/tmp/inputs/PocketFlow/tests/test_batch_flow.py
5.0K	/tmp/inputs/PocketFlow/tests/test_batch_node.py
9.5K	/tmp/inputs/PocketFlow/tests/test_fall_back.py
9.5K	/tmp/inputs/PocketFlow/tests/test_flow_basic.py
6.0K	/tmp/inputs/PocketFlow/tests/test_flow_composition.py
15K	/tmp/inputs/PocketFlow/utils
15K	/tmp/inputs/PocketFlow/utils/update_pocketflow_mdc.py
</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/__init__.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	import asyncio, warnings, copy, time
     2	
     3	class BaseNode:
     4	    def __init__(self): self.params,self.successors={},{}
     5	    def set_params(self,params): self.params=params
     6	    def next(self,node,action="default"):
     7	        if action in self.successors: warnings.warn(f"Overwriting successor for action '{action}'")
     8	        self.successors[action]=node; return node
     9	    def prep(self,shared): pass
    10	    def exec(self,prep_res): pass
    11	    def post(self,shared,prep_res,exec_res): pass
    12	    def _exec(self,prep_res): return self.exec(prep_res)
    13	    def _run(self,shared): p=self.prep(shared); e=self._exec(p); return self.post(shared,p,e)
    14	    def run(self,shared): 
    15	        if self.successors: warnings.warn("Node won't run successors. Use Flow.")  
    16	        return self._run(shared)
    17	    def __rshift__(self,other): return self.next(other)
    18	    def __sub__(self,action):
    19	        if isinstance(action,str): return _ConditionalTransition(self,action)
    20	        raise TypeError("Action must be a string")
    21	
    22	class _ConditionalTransition:
    23	    def __init__(self,src,action): self.src,self.action=src,action
    24	    def __rshift__(self,tgt): return self.src.next(tgt,self.action)
    25	
    26	class Node(BaseNode):
    27	    def __init__(self,max_retries=1,wait=0): super().__init__(); self.max_retries,self.wait=max_retries,wait
    28	    def exec_fallback(self,prep_res,exc): raise exc
    29	    def _exec(self,prep_res):
    30	        for self.cur_retry in range(self.max_retries):
    31	            try: return self.exec(prep_res)
    32	            except Exception as e:
    33	                if self.cur_retry==self.max_retries-1: return self.exec_fallback(prep_res,e)
    34	                if self.wait&gt;0: time.sleep(self.wait)
    35	
    36	class BatchNode(Node):
    37	    def _exec(self,items): return [super(BatchNode,self)._exec(i) for i in (items or [])]
    38	
    39	class Flow(BaseNode):
    40	    def __init__(self,start=None): super().__init__(); self.start_node=start
    41	    def start(self,start): self.start_node=start; return start
    42	    def get_next_node(self,curr,action):
    43	        nxt=curr.successors.get(action or "default")
    44	        if not nxt and curr.successors: warnings.warn(f"Flow ends: '{action}' not found in {list(curr.successors)}")
    45	        return nxt
    46	    def _orch(self,shared,params=None):
    47	        curr,p,last_action =copy.copy(self.start_node),(params or {**self.params}),None
    48	        while curr: curr.set_params(p); last_action=curr._run(shared); curr=copy.copy(self.get_next_node(curr,last_action))
    49	        return last_action
    50	    def _run(self,shared): p=self.prep(shared); o=self._orch(shared); return self.post(shared,p,o)
    51	    def post(self,shared,prep_res,exec_res): return exec_res
    52	
    53	class BatchFlow(Flow):
    54	    def _run(self,shared):
    55	        pr=self.prep(shared) or []
    56	        for bp in pr: self._orch(shared,{**self.params,**bp})
    57	        return self.post(shared,pr,None)
    58	
    59	class AsyncNode(Node):
    60	    async def prep_async(self,shared): pass
    61	    async def exec_async(self,prep_res): pass
    62	    async def exec_fallback_async(self,prep_res,exc): raise exc
    63	    async def post_async(self,shared,prep_res,exec_res): pass
    64	    async def _exec(self,prep_res): 
    65	        for self.cur_retry in range(self.max_retries):
    66	            try: return await self.exec_async(prep_res)
    67	            except Exception as e:
    68	                if self.cur_retry==self.max_retries-1: return await self.exec_fallback_async(prep_res,e)
    69	                if self.wait&gt;0: await asyncio.sleep(self.wait)
    70	    async def run_async(self,shared): 
    71	        if self.successors: warnings.warn("Node won't run successors. Use AsyncFlow.")  
    72	        return await self._run_async(shared)
    73	    async def _run_async(self,shared): p=await self.prep_async(shared); e=await self._exec(p); return await self.post_async(shared,p,e)
    74	    def _run(self,shared): raise RuntimeError("Use run_async.")
    75	
    76	class AsyncBatchNode(AsyncNode,BatchNode):
    77	    async def _exec(self,items): return [await super(AsyncBatchNode,self)._exec(i) for i in items]
    78	
    79	class AsyncParallelBatchNode(AsyncNode,BatchNode):
    80	    async def _exec(self,items): return await asyncio.gather(*(super(AsyncParallelBatchNode,self)._exec(i) for i in items))
    81	
    82	class AsyncFlow(Flow,AsyncNode):
    83	    async def _orch_async(self,shared,params=None):
    84	        curr,p,last_action =copy.copy(self.start_node),(params or {**self.params}),None
    85	        while curr: curr.set_params(p); last_action=await curr._run_async(shared) if isinstance(curr,AsyncNode) else curr._run(shared); curr=copy.copy(self.get_next_node(curr,last_action))
    86	        return last_action
    87	    async def _run_async(self,shared): p=await self.prep_async(shared); o=await self._orch_async(shared); return await self.post_async(shared,p,o)
    88	    async def post_async(self,shared,prep_res,exec_res): return exec_res
    89	
    90	class AsyncBatchFlow(AsyncFlow,BatchFlow):
    91	    async def _run_async(self,shared):
    92	        pr=await self.prep_async(shared) or []
    93	        for bp in pr: await self._orch_async(shared,{**self.params,**bp})
    94	        return await self.post_async(shared,pr,None)
    95	
    96	class AsyncParallelBatchFlow(AsyncFlow,BatchFlow):
    97	    async def _run_async(self,shared): 
    98	        pr=await self.prep_async(shared) or []
    99	        await asyncio.gather(*(self._orch_async(shared,{**self.params,**bp}) for bp in pr))
   100	        return await self.post_async(shared,pr,None)</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cat /tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-background/*.py 2&gt;/dev/null | head -100</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">from pocketflow import Flow
from nodes import GenerateOutline, WriteContent, ApplyStyle

def create_article_flow():
    """
    Create and configure the article writing workflow
    """
    # Create node instances
    outline_node = GenerateOutline()
    content_node = WriteContent()
    style_node = ApplyStyle()
    
    # Connect nodes in sequence
    outline_node &gt;&gt; content_node &gt;&gt; style_node
    
    # Create flow starting with outline node
    article_flow = Flow(start=outline_node)
    
    return article_flow import asyncio
import json
import uuid
from fastapi import FastAPI, BackgroundTasks, Form
from fastapi.responses import StreamingResponse
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
from flow import create_article_flow

app = FastAPI()

# Mount static files
app.mount("/static", StaticFiles(directory="static"), name="static")

# Store active jobs and their SSE queues
active_jobs = {}

def run_article_workflow(job_id: str, topic: str):
    """Run the article workflow in background"""
    try:
        # Get the pre-created queue from active_jobs
        sse_queue = active_jobs[job_id]
        shared = {
            "topic": topic,
            "sse_queue": sse_queue,
            "sections": [],
            "draft": "",
            "final_article": ""
        }
        
        # Run the workflow
        flow = create_article_flow()
        flow.run(shared)
        
    except Exception as e:
        # Send error message
        error_msg = {"step": "error", "progress": 0, "data": {"error": str(e)}}
        if job_id in active_jobs:
            active_jobs[job_id].put_nowait(error_msg)

@app.post("/start-job")
async def start_job(background_tasks: BackgroundTasks, topic: str = Form(...)):
    """Start a new article generation job"""
    job_id = str(uuid.uuid4())
    
    # Create SSE queue and register job immediately
    sse_queue = asyncio.Queue()
    active_jobs[job_id] = sse_queue
    
    # Start background task
    background_tasks.add_task(run_article_workflow, job_id, topic)
    
    return {"job_id": job_id, "topic": topic, "status": "started"}

@app.get("/progress/{job_id}")
async def get_progress(job_id: str):
    """Stream progress updates via SSE"""
    
    async def event_stream():
        if job_id not in active_jobs:
            yield f"data: {json.dumps({'error': 'Job not found'})}\n\n"
            return
            
        sse_queue = active_jobs[job_id]
        
        # Send initial connection confirmation
        yield f"data: {json.dumps({'step': 'connected', 'progress': 0, 'data': {'message': 'Connected to job progress'}})}\n\n"
        
        try:
            while True:
                # Wait for next progress update
                try:
                    # Use asyncio.wait_for to avoid blocking forever
                    progress_msg = await asyncio.wait_for(sse_queue.get(), timeout=1.0)
                    yield f"data: {json.dumps(progress_msg)}\n\n"
                    
                    # If job is complete, clean up and exit
                    if progress_msg.get("step") == "complete":
                        del active_jobs[job_id]
                        break
                        
                except asyncio.TimeoutError:</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">ls -la /tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-websocket/</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">total 6
drwxr-xr-x  6 argocd root  220 Feb 27 13:25 .
drwxr-xr-x 47 argocd root  980 Feb 27 13:25 ..
-rw-r--r--  1 argocd root 1794 Jan  1  1970 README.md
drwxr-xr-x  2 argocd root   60 Feb 27 13:25 assets
drwxr-xr-x  2 argocd root   60 Feb 27 13:25 docs
-rw-r--r--  1 argocd root  183 Jan  1  1970 flow.py
-rw-r--r--  1 argocd root 1221 Jan  1  1970 main.py
-rw-r--r--  1 argocd root 1450 Jan  1  1970 nodes.py
-rw-r--r--  1 argocd root   71 Jan  1  1970 requirements.txt
drwxr-xr-x  2 argocd root   60 Feb 27 13:25 static
drwxr-xr-x  2 argocd root   80 Feb 27 13:25 utils</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cat /tmp/inputs/PocketFlow/cookbook/pocketflow-fastapi-websocket/main.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">import json
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.staticfiles import StaticFiles
from fastapi.responses import FileResponse
from flow import create_streaming_chat_flow

app = FastAPI()
app.mount("/static", StaticFiles(directory="static"), name="static")

@app.get("/")
async def get_chat_interface():
    return FileResponse("static/index.html")

@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    
    # Initialize conversation history for this connection
    shared_store = {
        "websocket": websocket,
        "conversation_history": []
    }
    
    try:
        while True:
            data = await websocket.receive_text()
            message = json.loads(data)
            
            # Update only the current message, keep conversation history
            shared_store["user_message"] = message.get("content", "")
            
            flow = create_streaming_chat_flow()
            await flow.run_async(shared_store)
            
    except WebSocketDisconnect:
        pass

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000) </span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cat /tmp/inputs/PocketFlow/tests/test_async_flow.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">import unittest
import asyncio
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))
from pocketflow import Node, AsyncNode, AsyncFlow

class AsyncNumberNode(AsyncNode):
    """
    Simple async node that sets 'current' to a given number.
    Demonstrates overriding .process() (sync) and using
    post_async() for the async portion.
    """
    def __init__(self, number):
        super().__init__()
        self.number = number

    async def prep_async(self, shared_storage):
        # Synchronous work is allowed inside an AsyncNode,
        # but final 'condition' is determined by post_async().
        shared_storage['current'] = self.number
        return "set_number"

    async def post_async(self, shared_storage, prep_result, proc_result):
        # Possibly do asynchronous tasks here
        await asyncio.sleep(0.01)
        # Return a condition for the flow
        return "number_set"

class AsyncIncrementNode(AsyncNode):
    """
    Demonstrates incrementing the 'current' value asynchronously.
    """
    async def prep_async(self, shared_storage):
        shared_storage['current'] = shared_storage.get('current', 0) + 1
        return "incremented"

    async def post_async(self, shared_storage, prep_result, proc_result):
        await asyncio.sleep(0.01)  # simulate async I/O
        return "done"

class AsyncSignalNode(AsyncNode):
    """ An async node that returns a specific signal string from post_async. """
    def __init__(self, signal="default_async_signal"):
        super().__init__()
        self.signal = signal

    # No prep needed usually if just signaling
    async def prep_async(self, shared_storage):
        await asyncio.sleep(0.01) # Simulate async work

    async def post_async(self, shared_storage, prep_result, exec_result):
        # Store the signal in shared storage for verification
        shared_storage['last_async_signal_emitted'] = self.signal
        await asyncio.sleep(0.01) # Simulate async work
        print(self.signal)
        return self.signal # Return the specific action string

class AsyncPathNode(AsyncNode):
    """ An async node to indicate which path was taken in the outer flow. """
    def __init__(self, path_id):
        super().__init__()
        self.path_id = path_id

    async def prep_async(self, shared_storage):
        await asyncio.sleep(0.01) # Simulate async work
        shared_storage['async_path_taken'] = self.path_id

    # post_async implicitly returns None (for default transition out if needed)
    async def post_async(self, shared_storage, prep_result, exec_result):
         await asyncio.sleep(0.01)
         # Return None by default

class TestAsyncNode(unittest.TestCase):
    """
    Test the AsyncNode (and descendants) in isolation (not in a flow).
    """
    def test_async_number_node_direct_call(self):
        """
        Even though AsyncNumberNode is designed for an async flow,
        we can still test it directly by calling run_async().
        """
        async def run_node():
            node = AsyncNumberNode(42)
            shared_storage = {}
            condition = await node.run_async(shared_storage)
            return shared_storage, condition

        shared_storage, condition = asyncio.run(run_node())
        self.assertEqual(shared_storage['current'], 42)
        self.assertEqual(condition, "number_set")

    def test_async_increment_node_direct_call(self):
        async def run_node():
            node = AsyncIncrementNode()
            shared_storage = {'current': 10}
            condition = await node.run_async(shared_storage)
            return shared_storage, condition

        shared_storage, condition = asyncio.run(run_node())
        self.assertEqual(shared_storage['current'], 11)
        self.assertEqual(condition, "done")


class TestAsyncFlow(unittest.TestCase):
    """
    Test how AsyncFlow orchestrates multiple async nodes.
    """
    def test_simple_async_flow(self):
        """
        Flow:
          1) AsyncNumberNode(5) -&gt; sets 'current' to 5
          2) AsyncIncrementNode() -&gt; increments 'current' to 6
        """

        # Create our nodes
        start = AsyncNumberNode(5)
        inc_node = AsyncIncrementNode()

        # Chain them: start &gt;&gt; inc_node
        start - "number_set" &gt;&gt; inc_node

        # Create an AsyncFlow with start
        flow = AsyncFlow(start)

        # We'll run the flow synchronously (which under the hood is asyncio.run())
        shared_storage = {}
        asyncio.run(flow.run_async(shared_storage))

        self.assertEqual(shared_storage['current'], 6)

    def test_async_flow_branching(self):
        """
        Demonstrate a branching scenario where we return different
        conditions. For example, you could have an async node that
        returns "go_left" or "go_right" in post_async, but here
        we'll keep it simpler for demonstration.
        """

        class BranchingAsyncNode(AsyncNode):
            def exec(self, data):
                value = shared_storage.get("value", 0)
                shared_storage["value"] = value
                # We'll decide branch based on whether 'value' is positive
                return None

            async def post_async(self, shared_storage, prep_result, proc_result):
                await asyncio.sleep(0.01)
                if shared_storage["value"] &gt;= 0:
                    return "positive_branch"
                else:
                    return "negative_branch"

        class PositiveNode(Node):
            def exec(self, data):
                shared_storage["path"] = "positive"
                return None

        class NegativeNode(Node):
            def exec(self, data):
                shared_storage["path"] = "negative"
                return None

        shared_storage = {"value": 10}

        start = BranchingAsyncNode()
        positive_node = PositiveNode()
        negative_node = NegativeNode()

        # Condition-based chaining
        start - "positive_branch" &gt;&gt; positive_node
        start - "negative_branch" &gt;&gt; negative_node

        flow = AsyncFlow(start)
        asyncio.run(flow.run_async(shared_storage))

        self.assertEqual(shared_storage["path"], "positive", 
                         "Should have taken the positive branch")

    def test_async_composition_with_action_propagation(self):
        """
        Test AsyncFlow branches based on action from nested AsyncFlow's last node.
        """
        async def run_test():
            shared_storage = {}

            # 1. Define an inner async flow ending with AsyncSignalNode
            # Use existing AsyncNumberNode which should return None from post_async implicitly
            inner_start_node = AsyncNumberNode(200)
            inner_end_node = AsyncSignalNode("async_inner_done") # post_async -&gt; "async_inner_done"
            inner_start_node - "number_set" &gt;&gt; inner_end_node
            # Inner flow will execute start-&gt;end, Flow exec returns "async_inner_done"
            inner_flow = AsyncFlow(start=inner_start_node)

            # 2. Define target async nodes for the outer flow branches
            path_a_node = AsyncPathNode("AsyncA") # post_async -&gt; None
            path_b_node = AsyncPathNode("AsyncB") # post_async -&gt; None

            # 3. Define the outer async flow starting with the inner async flow
            outer_flow = AsyncFlow(start=inner_flow)

            # 4. Define branches FROM the inner_flow object based on its returned action
            inner_flow - "async_inner_done" &gt;&gt; path_b_node  # This path should be taken
            inner_flow - "other_action" &gt;&gt; path_a_node      # This path should NOT be taken

            # 5. Run the outer async flow and capture the last action
            # Execution: inner_start -&gt; inner_end -&gt; path_b
            last_action_outer = await outer_flow.run_async(shared_storage)

            # 6. Return results for assertion
            return shared_storage, last_action_outer

        # Run the async test function
        shared_storage, last_action_outer = asyncio.run(run_test())

        # 7. Assert the results
        # Check state after inner flow execution
        self.assertEqual(shared_storage.get('current'), 200) # From AsyncNumberNode
        self.assertEqual(shared_storage.get('last_async_signal_emitted'), "async_inner_done")
        # Check that the correct outer path was taken
        self.assertEqual(shared_storage.get('async_path_taken'), "AsyncB")
        # Check the action returned by the outer flow. The last node executed was
        # path_b_node, which returns None from its post_async method.
        self.assertIsNone(last_action_outer)

if __name__ == '__main__':
    unittest.main()</span></div></div><span class="leading-6 whitespace-pre-wrap">
Now let me check the existing tests structure:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">head -50 /tmp/inputs/PocketFlow/tests/test_flow_basic.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap"># tests/test_flow_basic.py
import unittest
import sys
from pathlib import Path
import warnings

sys.path.insert(0, str(Path(__file__).parent.parent))
from pocketflow import Node, Flow

# --- Node Definitions ---
# Nodes intended for default transitions (&gt;&gt;) should NOT return a specific
# action string from post. Let it return None by default.
# Nodes intended for conditional transitions (-) MUST return the action string.

class NumberNode(Node):
    def __init__(self, number):
        super().__init__()
        self.number = number
    def prep(self, shared_storage):
        shared_storage['current'] = self.number
    # post implicitly returns None - used for default transition

class AddNode(Node):
    def __init__(self, number):
        super().__init__()
        self.number = number
    def prep(self, shared_storage):
        shared_storage['current'] += self.number
    # post implicitly returns None - used for default transition

class MultiplyNode(Node):
    def __init__(self, number):
        super().__init__()
        self.number = number
    def prep(self, shared_storage):
        shared_storage['current'] *= self.number
    # post implicitly returns None - used for default transition

class CheckPositiveNode(Node):
   # This node IS designed for conditional branching
   def prep(self, shared_storage):
       pass
   def post(self, shared_storage, prep_result, proc_result):
        # MUST return the specific action string for branching
        if shared_storage['current'] &gt;= 0:
            return 'positive'
        else:
            return 'negative'

class NoOpNode(Node):</span></div></div><span class="leading-6 whitespace-pre-wrap">
Now I have enough context. Let me create the FastAPI integration module:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">create</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">file_text</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">"""
FastAPI integration for PocketFlow.

Provides mount_flow() helper to automatically register routes for running flows.
"""

import asyncio
import json
import time
from typing import Any, Callable, Optional, Union
from dataclasses import dataclass, field

try:
    from fastapi import APIRouter, HTTPException, Request
    from fastapi.responses import StreamingResponse
    from pydantic import BaseModel
except ImportError:
    raise ImportError(
        "FastAPI integration requires fastapi and pydantic. "
        "Install with: pip install fastapi pydantic"
    )

from . import Flow, AsyncFlow


class RunRequest(BaseModel):
    shared: dict = {}
    params: dict = {}


class RunResponse(BaseModel):
    result: Any
    shared: dict


@dataclass
class FlowMetrics:
    total_runs: int = 0
    successful_runs: int = 0
    failed_runs: int = 0
    total_time_ms: float = 0.0
    last_run_time_ms: float = 0.0
    last_error: Optional[str] = None


_metrics_store: dict[str, FlowMetrics] = {}


def mount_flow(
    flow: Union[Flow, AsyncFlow],
    *,
    prefix: str = "",
    name: str = "flow",
    enable_streaming: bool = True,
    enable_metrics: bool = True,
    prep_shared: Optional[Callable[[dict], dict]] = None,
    on_error: Optional[Callable[[Exception], Any]] = None,
) -&gt; APIRouter:
    """
    Create a FastAPI router with routes for running a PocketFlow flow.

    Args:
        flow: A Flow or AsyncFlow instance to mount.
        prefix: URL prefix for all routes (e.g., "/api/v1").
        name: Name used in metrics and route tags.
        enable_streaming: Whether to enable the /stream endpoint.
        enable_metrics: Whether to enable the /metrics endpoint.
        prep_shared: Optional function to preprocess shared dict before running.
        on_error: Optional error handler function.

    Returns:
        APIRouter with /run, /stream (optional), /metrics (optional), and /health routes.

    Example:
        from pocketflow import Flow, AsyncFlow
        from pocketflow.fastapi import mount_flow
        from fastapi import FastAPI

        app = FastAPI()
        my_flow = Flow(start=my_node)
        app.include_router(mount_flow(my_flow, prefix="/workflow"))
    """
    router = APIRouter(prefix=prefix, tags=[name])
    is_async = isinstance(flow, AsyncFlow)

    if name not in _metrics_store:
        _metrics_store[name] = FlowMetrics()

    def get_metrics() -&gt; FlowMetrics:
        return _metrics_store[name]

    def update_metrics(success: bool, duration_ms: float, error: Optional[str] = None):
        m = get_metrics()
        m.total_runs += 1
        m.total_time_ms += duration_ms
        m.last_run_time_ms = duration_ms
        if success:
            m.successful_runs += 1
        else:
            m.failed_runs += 1
            m.last_error = error

    def handle_error(e: Exception) -&gt; dict:
        if on_error:
            return on_error(e)
        return {"error": str(e), "type": type(e).__name__}

    @router.post("/run", response_model=RunResponse)
    async def run_flow(request: RunRequest):
        shared = dict(request.shared)
        if prep_shared:
            shared = prep_shared(shared)

        if request.params:
            flow.set_params(request.params)

        start_time = time.perf_counter()
        try:
            if is_async:
                result = await flow.run_async(shared)
            else:
                result = await asyncio.to_thread(flow.run, shared)
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                update_metrics(True, duration_ms)
            return RunResponse(result=result, shared=shared)
        except Exception as e:
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                update_metrics(False, duration_ms, str(e))
            raise HTTPException(status_code=500, detail=handle_error(e))

    if enable_streaming:

        @router.post("/stream")
        async def stream_flow(request: RunRequest):
            shared = dict(request.shared)
            if prep_shared:
                shared = prep_shared(shared)

            if request.params:
                flow.set_params(request.params)

            stream_queue: asyncio.Queue = asyncio.Queue()
            shared["_stream_queue"] = stream_queue

            async def run_and_signal():
                start_time = time.perf_counter()
                try:
                    if is_async:
                        result = await flow.run_async(shared)
                    else:
                        result = await asyncio.to_thread(flow.run, shared)
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        update_metrics(True, duration_ms)
                    await stream_queue.put({"type": "complete", "result": result})
                except Exception as e:
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        update_metrics(False, duration_ms, str(e))
                    await stream_queue.put({"type": "error", "error": str(e)})

            async def event_generator():
                task = asyncio.create_task(run_and_signal())
                try:
                    while True:
                        try:
                            msg = await asyncio.wait_for(stream_queue.get(), timeout=30.0)
                            yield f"data: {json.dumps(msg)}\n\n"
                            if msg.get("type") in ("complete", "error"):
                                break
                        except asyncio.TimeoutError:
                            yield f"data: {json.dumps({'type': 'keepalive'})}\n\n"
                finally:
                    if not task.done():
                        task.cancel()
                        try:
                            await task
                        except asyncio.CancelledError:
                            pass

            return StreamingResponse(
                event_generator(),
                media_type="text/event-stream",
                headers={
                    "Cache-Control": "no-cache",
                    "Connection": "keep-alive",
                    "X-Accel-Buffering": "no",
                },
            )

    if enable_metrics:

        @router.get("/metrics")
        async def get_flow_metrics():
            m = get_metrics()
            avg_time = m.total_time_ms / m.total_runs if m.total_runs &gt; 0 else 0
            return {
                "name": name,
                "total_runs": m.total_runs,
                "successful_runs": m.successful_runs,
                "failed_runs": m.failed_runs,
                "success_rate": m.successful_runs / m.total_runs if m.total_runs &gt; 0 else 0,
                "avg_time_ms": avg_time,
                "last_run_time_ms": m.last_run_time_ms,
                "last_error": m.last_error,
            }

    @router.get("/health")
    async def health_check():
        return {"status": "healthy", "flow": name, "type": "async" if is_async else "sync"}

    return router


def stream_event(shared: dict, event_type: str, data: Any):
    """
    Helper function to send a streaming event from within a node.

    Use this inside your node's exec/exec_async method to push events to the stream.

    Args:
        shared: The shared dict passed to the node.
        event_type: A string identifying the event type (e.g., "progress", "token").
        data: The event data to send.

    Example:
        class MyNode(AsyncNode):
            async def exec_async(self, prep_res):
                for i in range(10):
                    stream_event(self.shared, "progress", {"step": i})
                    await asyncio.sleep(0.1)
    """
    queue = shared.get("_stream_queue")
    if queue is not None:
        try:
            queue.put_nowait({"type": event_type, "data": data})
        except Exception:
            pass
</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">New file created successfully at /tmp/inputs/PocketFlow/pocketflow/fastapi.py</span></div></div><span class="leading-6 whitespace-pre-wrap">
Now update the main `__init__.py` to expose the FastAPI integration:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/__init__.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">import asyncio, warnings, copy, time</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">import asyncio, warnings, copy, time

def __getattr__(name):
    if name in ("mount_flow", "stream_event"):
        from .fastapi import mount_flow, stream_event
        return mount_flow if name == "mount_flow" else stream_event
    raise AttributeError(f"module {__name__!r} has no attribute {name!r}")</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/inputs/PocketFlow/pocketflow/__init__.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">
Now let's create tests for the FastAPI integration:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">create</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/tests/test_fastapi_integration.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">file_text</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">import unittest
import asyncio
import sys
from pathlib import Path

sys.path.insert(0, str(Path(__file__).parent.parent))

try:
    from fastapi import FastAPI
    from fastapi.testclient import TestClient
    FASTAPI_AVAILABLE = True
except ImportError:
    FASTAPI_AVAILABLE = False

from pocketflow import Node, AsyncNode, Flow, AsyncFlow


class AddNumberNode(Node):
    def __init__(self, number):
        super().__init__()
        self.number = number

    def prep(self, shared):
        shared["result"] = shared.get("result", 0) + self.number


class AsyncAddNode(AsyncNode):
    def __init__(self, number):
        super().__init__()
        self.number = number

    async def prep_async(self, shared):
        await asyncio.sleep(0.01)
        shared["result"] = shared.get("result", 0) + self.number


class ErrorNode(Node):
    def prep(self, shared):
        raise ValueError("Intentional error")


class StreamingNode(AsyncNode):
    async def exec_async(self, prep_res):
        from pocketflow.fastapi import stream_event
        shared = self.params.get("_shared", {})
        for i in range(3):
            stream_event(shared, "progress", {"step": i})
            await asyncio.sleep(0.01)
        return "done"


@unittest.skipUnless(FASTAPI_AVAILABLE, "FastAPI not installed")
class TestMountFlow(unittest.TestCase):

    def test_sync_flow_run(self):
        from pocketflow.fastapi import mount_flow

        node1 = AddNumberNode(10)
        node2 = AddNumberNode(5)
        node1 &gt;&gt; node2
        flow = Flow(start=node1)

        app = FastAPI()
        app.include_router(mount_flow(flow, name="test_sync"))

        client = TestClient(app)
        response = client.post("/run", json={"shared": {"result": 0}})
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertEqual(data["shared"]["result"], 15)

    def test_async_flow_run(self):
        from pocketflow.fastapi import mount_flow

        node1 = AsyncAddNode(20)
        node2 = AsyncAddNode(10)
        node1 &gt;&gt; node2
        flow = AsyncFlow(start=node1)

        app = FastAPI()
        app.include_router(mount_flow(flow, name="test_async"))

        client = TestClient(app)
        response = client.post("/run", json={"shared": {"result": 5}})
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertEqual(data["shared"]["result"], 35)

    def test_health_endpoint(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="health_test"))

        client = TestClient(app)
        response = client.get("/health")
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertEqual(data["status"], "healthy")
        self.assertEqual(data["flow"], "health_test")
        self.assertEqual(data["type"], "sync")

    def test_metrics_endpoint(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="metrics_test"))

        client = TestClient(app)
        client.post("/run", json={"shared": {}})
        client.post("/run", json={"shared": {}})

        response = client.get("/metrics")
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertEqual(data["name"], "metrics_test")
        self.assertGreaterEqual(data["total_runs"], 2)
        self.assertGreaterEqual(data["successful_runs"], 2)

    def test_error_handling(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=ErrorNode())
        app = FastAPI()
        app.include_router(mount_flow(flow, name="error_test"))

        client = TestClient(app)
        response = client.post("/run", json={"shared": {}})
        self.assertEqual(response.status_code, 500)
        data = response.json()
        self.assertIn("error", data["detail"])

    def test_prefix(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, prefix="/api/v1", name="prefix_test"))

        client = TestClient(app)
        response = client.get("/api/v1/health")
        self.assertEqual(response.status_code, 200)

    def test_prep_shared_callback(self):
        from pocketflow.fastapi import mount_flow

        def prep_shared(shared):
            shared["injected"] = True
            return shared

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="prep_test", prep_shared=prep_shared))

        client = TestClient(app)
        response = client.post("/run", json={"shared": {}})
        self.assertEqual(response.status_code, 200)
        data = response.json()
        self.assertTrue(data["shared"]["injected"])

    def test_stream_endpoint(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="stream_test", enable_streaming=True))

        client = TestClient(app)
        with client.stream("POST", "/stream", json={"shared": {}}) as response:
            self.assertEqual(response.status_code, 200)
            events = []
            for line in response.iter_lines():
                if line.startswith("data:"):
                    events.append(line)
            self.assertTrue(len(events) &gt; 0)

    def test_disabled_streaming(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_stream", enable_streaming=False))

        client = TestClient(app)
        response = client.post("/stream", json={"shared": {}})
        self.assertEqual(response.status_code, 405)

    def test_disabled_metrics(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_metrics", enable_metrics=False))

        client = TestClient(app)
        response = client.get("/metrics")
        self.assertEqual(response.status_code, 405)

    def test_custom_error_handler(self):
        from pocketflow.fastapi import mount_flow

        def custom_error_handler(e):
            return {"custom_error": True, "message": str(e)}

        flow = Flow(start=ErrorNode())
        app = FastAPI()
        app.include_router(mount_flow(flow, name="custom_err", on_error=custom_error_handler))

        client = TestClient(app)
        response = client.post("/run", json={"shared": {}})
        self.assertEqual(response.status_code, 500)
        data = response.json()
        self.assertTrue(data["detail"]["custom_error"])


if __name__ == "__main__":
    unittest.main()
</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">New file created successfully at /tmp/inputs/PocketFlow/tests/test_fastapi_integration.py</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cd /tmp/inputs/PocketFlow &amp;&amp; pip install fastapi pydantic httpx -q &amp;&amp; python -m pytest tests/test_fastapi_integration.py -v 2&gt;&amp;1 | head -80</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">============================= test session starts ==============================
platform linux -- Python 3.9.7, pytest-6.2.4, py-1.10.0, pluggy-0.13.1 -- /opt/conda/bin/python
cachedir: .pytest_cache
hypothesis profile 'default' -&gt; database=DirectoryBasedExampleDatabase('/tmp/inputs/PocketFlow/.hypothesis/examples')
rootdir: /tmp/inputs/PocketFlow
plugins: reportlog-0.3.0, hypothesis-6.75.3, cov-4.1.0, timeout-2.1.0, anyio-3.7.1
collecting ... collected 11 items

tests/test_fastapi_integration.py::TestMountFlow::test_async_flow_run PASSED [  9%]
tests/test_fastapi_integration.py::TestMountFlow::test_custom_error_handler PASSED [ 18%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_metrics FAILED [ 27%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_streaming FAILED [ 36%]
tests/test_fastapi_integration.py::TestMountFlow::test_error_handling PASSED [ 45%]
tests/test_fastapi_integration.py::TestMountFlow::test_health_endpoint PASSED [ 54%]
tests/test_fastapi_integration.py::TestMountFlow::test_metrics_endpoint PASSED [ 63%]
tests/test_fastapi_integration.py::TestMountFlow::test_prefix PASSED     [ 72%]
tests/test_fastapi_integration.py::TestMountFlow::test_prep_shared_callback PASSED [ 81%]
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint FAILED [ 90%]
tests/test_fastapi_integration.py::TestMountFlow::test_sync_flow_run PASSED [100%]

=================================== FAILURES ===================================
_____________________ TestMountFlow.test_disabled_metrics ______________________

self = &lt;test_fastapi_integration.TestMountFlow testMethod=test_disabled_metrics&gt;

    def test_disabled_metrics(self):
        from pocketflow.fastapi import mount_flow
    
        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_metrics", enable_metrics=False))
    
        client = TestClient(app)
        response = client.get("/metrics")
&gt;       self.assertEqual(response.status_code, 405)
E       AssertionError: 404 != 405

tests/test_fastapi_integration.py:199: AssertionError
____________________ TestMountFlow.test_disabled_streaming _____________________

self = &lt;test_fastapi_integration.TestMountFlow testMethod=test_disabled_streaming&gt;

    def test_disabled_streaming(self):
        from pocketflow.fastapi import mount_flow
    
        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_stream", enable_streaming=False))
    
        client = TestClient(app)
        response = client.post("/stream", json={"shared": {}})
&gt;       self.assertEqual(response.status_code, 405)
E       AssertionError: 404 != 405

tests/test_fastapi_integration.py:188: AssertionError
______________________ TestMountFlow.test_stream_endpoint ______________________

self = &lt;test_fastapi_integration.TestMountFlow testMethod=test_stream_endpoint&gt;

    def test_stream_endpoint(self):
        from pocketflow.fastapi import mount_flow
    
        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="stream_test", enable_streaming=True))
    
        client = TestClient(app)
&gt;       with client.stream("POST", "/stream", json={"shared": {}}) as response:
E       TypeError: 'bool' object is not callable

tests/test_fastapi_integration.py:171: TypeError
=========================== short test summary info ============================
FAILED tests/test_fastapi_integration.py::TestMountFlow::test_disabled_metrics
FAILED tests/test_fastapi_integration.py::TestMountFlow::test_disabled_streaming
FAILED tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint
========================= 3 failed, 8 passed in 2.53s ==========================
ERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.
thinc 8.3.2 requires numpy&lt;2.1.0,&gt;=2.0.0; python_version &gt;= "3.9", but you have numpy 1.23.5 which is incompatible.</span></div></div><span class="leading-6 whitespace-pre-wrap">
Let me fix those tests - 404 is correct when route doesn't exist, and streaming test needs different approach:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/tests/test_fastapi_integration.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    def test_stream_endpoint(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="stream_test", enable_streaming=True))

        client = TestClient(app)
        with client.stream("POST", "/stream", json={"shared": {}}) as response:
            self.assertEqual(response.status_code, 200)
            events = []
            for line in response.iter_lines():
                if line.startswith("data:"):
                    events.append(line)
            self.assertTrue(len(events) &gt; 0)

    def test_disabled_streaming(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_stream", enable_streaming=False))

        client = TestClient(app)
        response = client.post("/stream", json={"shared": {}})
        self.assertEqual(response.status_code, 405)

    def test_disabled_metrics(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_metrics", enable_metrics=False))

        client = TestClient(app)
        response = client.get("/metrics")
        self.assertEqual(response.status_code, 405)</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    def test_stream_endpoint(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="stream_test", enable_streaming=True))

        client = TestClient(app)
        response = client.post("/stream", json={"shared": {}})
        self.assertEqual(response.status_code, 200)
        self.assertIn("complete", response.text)

    def test_disabled_streaming(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_stream", enable_streaming=False))

        client = TestClient(app)
        response = client.post("/stream", json={"shared": {}})
        self.assertEqual(response.status_code, 404)

    def test_disabled_metrics(self):
        from pocketflow.fastapi import mount_flow

        flow = Flow(start=AddNumberNode(1))
        app = FastAPI()
        app.include_router(mount_flow(flow, name="no_metrics", enable_metrics=False))

        client = TestClient(app)
        response = client.get("/metrics")
        self.assertEqual(response.status_code, 404)</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/inputs/PocketFlow/tests/test_fastapi_integration.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cd /tmp/inputs/PocketFlow &amp;&amp; python -m pytest tests/test_fastapi_integration.py -v 2&gt;&amp;1</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">============================= test session starts ==============================
platform linux -- Python 3.9.7, pytest-6.2.4, py-1.10.0, pluggy-0.13.1 -- /opt/conda/bin/python
cachedir: .pytest_cache
hypothesis profile 'default' -&gt; database=DirectoryBasedExampleDatabase('/tmp/inputs/PocketFlow/.hypothesis/examples')
rootdir: /tmp/inputs/PocketFlow
plugins: reportlog-0.3.0, hypothesis-6.75.3, cov-4.1.0, timeout-2.1.0, anyio-3.7.1
collecting ... collected 11 items

tests/test_fastapi_integration.py::TestMountFlow::test_async_flow_run PASSED [  9%]
tests/test_fastapi_integration.py::TestMountFlow::test_custom_error_handler PASSED [ 18%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_metrics PASSED [ 27%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_streaming PASSED [ 36%]
tests/test_fastapi_integration.py::TestMountFlow::test_error_handling PASSED [ 45%]
tests/test_fastapi_integration.py::TestMountFlow::test_health_endpoint PASSED [ 54%]
tests/test_fastapi_integration.py::TestMountFlow::test_metrics_endpoint PASSED [ 63%]
tests/test_fastapi_integration.py::TestMountFlow::test_prefix PASSED     [ 72%]
tests/test_fastapi_integration.py::TestMountFlow::test_prep_shared_callback PASSED [ 81%]
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint PASSED [ 90%]
tests/test_fastapi_integration.py::TestMountFlow::test_sync_flow_run PASSED [100%]

=============================== warnings summary ===============================
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint
  /opt/conda/lib/python3.9/asyncio/base_events.py:542: DeprecationWarning: The loop argument is deprecated since Python 3.8, and scheduled for removal in Python 3.10.
    results = await tasks.gather(

-- Docs: https://docs.pytest.org/en/stable/warnings.html
======================== 11 passed, 1 warning in 1.09s =========================</span></div></div><span class="leading-6 whitespace-pre-wrap">
All tests pass. Let me also verify that the existing tests still work:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cd /tmp/inputs/PocketFlow &amp;&amp; python -m pytest tests/test_flow_basic.py tests/test_async_flow.py -v 2&gt;&amp;1 | tail -30</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">============================= test session starts ==============================
platform linux -- Python 3.9.7, pytest-6.2.4, py-1.10.0, pluggy-0.13.1 -- /opt/conda/bin/python
cachedir: .pytest_cache
hypothesis profile 'default' -&gt; database=DirectoryBasedExampleDatabase('/tmp/inputs/PocketFlow/.hypothesis/examples')
rootdir: /tmp/inputs/PocketFlow
plugins: reportlog-0.3.0, hypothesis-6.75.3, cov-4.1.0, timeout-2.1.0, anyio-3.7.1
collecting ... collected 13 items

tests/test_flow_basic.py::TestFlowBasic::test_branching_negative PASSED  [  7%]
tests/test_flow_basic.py::TestFlowBasic::test_branching_positive PASSED  [ 15%]
tests/test_flow_basic.py::TestFlowBasic::test_cycle_until_negative_ends_with_signal PASSED [ 23%]
tests/test_flow_basic.py::TestFlowBasic::test_flow_ends_warning_default_missing PASSED [ 30%]
tests/test_flow_basic.py::TestFlowBasic::test_flow_ends_warning_specific_missing PASSED [ 38%]
tests/test_flow_basic.py::TestFlowBasic::test_sequence_with_rshift PASSED [ 46%]
tests/test_flow_basic.py::TestFlowBasic::test_start_method_chaining PASSED [ 53%]
tests/test_flow_basic.py::TestFlowBasic::test_start_method_initialization PASSED [ 61%]
tests/test_async_flow.py::TestAsyncNode::test_async_increment_node_direct_call PASSED [ 69%]
tests/test_async_flow.py::TestAsyncNode::test_async_number_node_direct_call PASSED [ 76%]
tests/test_async_flow.py::TestAsyncFlow::test_async_composition_with_action_propagation PASSED [ 84%]
tests/test_async_flow.py::TestAsyncFlow::test_async_flow_branching PASSED [ 92%]
tests/test_async_flow.py::TestAsyncFlow::test_simple_async_flow PASSED   [100%]

============================== 13 passed in 0.82s ==============================</span></div></div><span class="leading-6 whitespace-pre-wrap">
Let me also update the type stub file:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/__init__.pyi</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	import asyncio
     2	from typing import Any, Dict, List, Optional, Union, TypeVar, Generic
     3	
     4	# Type variables for better type relationships
     5	_PrepResult = TypeVar('_PrepResult')
     6	_ExecResult = TypeVar('_ExecResult')
     7	_PostResult = TypeVar('_PostResult')
     8	
     9	# More specific parameter types
    10	ParamValue = Union[str, int, float, bool, None, List[Any], Dict[str, Any]]
    11	SharedData = Dict[str, Any]
    12	Params = Dict[str, ParamValue]
    13	
    14	class BaseNode(Generic[_PrepResult, _ExecResult, _PostResult]):
    15	    params: Params
    16	    successors: Dict[str, BaseNode[Any, Any, Any]]
    17	    
    18	    def __init__(self) -&gt; None: ...
    19	    def set_params(self, params: Params) -&gt; None: ...
    20	    def next(self, node: BaseNode[Any, Any, Any], action: str = "default") -&gt; BaseNode[Any, Any, Any]: ...
    21	    def prep(self, shared: SharedData) -&gt; _PrepResult: ...
    22	    def exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    23	    def post(self, shared: SharedData, prep_res: _PrepResult, exec_res: _ExecResult) -&gt; _PostResult: ...
    24	    def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    25	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    26	    def run(self, shared: SharedData) -&gt; _PostResult: ...
    27	    def __rshift__(self, other: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    28	    def __sub__(self, action: str) -&gt; _ConditionalTransition: ...
    29	
    30	class _ConditionalTransition:
    31	    src: BaseNode[Any, Any, Any]
    32	    action: str
    33	    
    34	    def __init__(self, src: BaseNode[Any, Any, Any], action: str) -&gt; None: ...
    35	    def __rshift__(self, tgt: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    36	
    37	class Node(BaseNode[_PrepResult, _ExecResult, _PostResult]):
    38	    max_retries: int
    39	    wait: Union[int, float]
    40	    cur_retry: int
    41	    
    42	    def __init__(self, max_retries: int = 1, wait: Union[int, float] = 0) -&gt; None: ...
    43	    def exec_fallback(self, prep_res: _PrepResult, exc: Exception) -&gt; _ExecResult: ...
    44	    def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    45	
    46	class BatchNode(Node[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    47	    def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    48	
    49	class Flow(BaseNode[_PrepResult, Any, _PostResult]):
    50	    start_node: Optional[BaseNode[Any, Any, Any]]
    51	    
    52	    def __init__(self, start: Optional[BaseNode[Any, Any, Any]] = None) -&gt; None: ...
    53	    def start(self, start: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    54	    def get_next_node(
    55	        self, curr: BaseNode[Any, Any, Any], action: Optional[str]
    56	    ) -&gt; Optional[BaseNode[Any, Any, Any]]: ...
    57	    def _orch(
    58	        self, shared: SharedData, params: Optional[Params] = None
    59	    ) -&gt; Any: ...
    60	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    61	    def post(self, shared: SharedData, prep_res: _PrepResult, exec_res: Any) -&gt; _PostResult: ...
    62	
    63	class BatchFlow(Flow[Optional[List[Params]], Any, _PostResult]):
    64	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    65	
    66	class AsyncNode(Node[_PrepResult, _ExecResult, _PostResult]):
    67	    async def prep_async(self, shared: SharedData) -&gt; _PrepResult: ...
    68	    async def exec_async(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    69	    async def exec_fallback_async(self, prep_res: _PrepResult, exc: Exception) -&gt; _ExecResult: ...
    70	    async def post_async(
    71	        self, shared: SharedData, prep_res: _PrepResult, exec_res: _ExecResult
    72	    ) -&gt; _PostResult: ...
    73	    async def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    74	    async def run_async(self, shared: SharedData) -&gt; _PostResult: ...
    75	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    76	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    77	
    78	class AsyncBatchNode(AsyncNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult], BatchNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    79	    async def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    80	
    81	class AsyncParallelBatchNode(AsyncNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult], BatchNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    82	    async def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    83	
    84	class AsyncFlow(Flow[_PrepResult, Any, _PostResult], AsyncNode[_PrepResult, Any, _PostResult]):
    85	    async def _orch_async(
    86	        self, shared: SharedData, params: Optional[Params] = None
    87	    ) -&gt; Any: ...
    88	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    89	    async def post_async(
    90	        self, shared: SharedData, prep_res: _PrepResult, exec_res: Any
    91	    ) -&gt; _PostResult: ...
    92	
    93	class AsyncBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    94	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    95	
    96	class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    97	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/__init__.pyi</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...

# FastAPI integration (lazy loaded)
def mount_flow(
    flow: Union[Flow[Any, Any, Any], AsyncFlow[Any, Any, Any]],
    *,
    prefix: str = "",
    name: str = "flow",
    enable_streaming: bool = True,
    enable_metrics: bool = True,
    prep_shared: Optional[Any] = None,
    on_error: Optional[Any] = None,
) -&gt; Any: ...

def stream_event(shared: SharedData, event_type: str, data: Any) -&gt; None: ...</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div>&lt;error&gt;<span class="leading-6 whitespace-pre-wrap">No replacement was performed, old_str `class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...` did not appear verbatim in /tmp/inputs/PocketFlow/pocketflow/__init__.pyi.</span>&lt;/error&gt;</div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cat -A /tmp/inputs/PocketFlow/pocketflow/__init__.pyi | tail -5</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">class AsyncBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):^M$
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...^M$
^M$
class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):^M$
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">sed -i 's/\r$//' /tmp/inputs/PocketFlow/pocketflow/__init__.pyi</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="border border-gray-200 rounded mb-2 text-normal text-gray-900 overflow-x-auto text-amber-700"><span class="leading-6 whitespace-pre-wrap">Tool ran without output or errors</span></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/inputs/PocketFlow/pocketflow/__init__.pyi</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...

# FastAPI integration (lazy loaded)
def mount_flow(
    flow: Union[Flow[Any, Any, Any], AsyncFlow[Any, Any, Any]],
    *,
    prefix: str = "",
    name: str = "flow",
    enable_streaming: bool = True,
    enable_metrics: bool = True,
    prep_shared: Optional[Any] = None,
    on_error: Optional[Any] = None,
) -&gt; Any: ...

def stream_event(shared: SharedData, event_type: str, data: Any) -&gt; None: ...</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/inputs/PocketFlow/pocketflow/__init__.pyi has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cd /tmp/inputs/PocketFlow &amp;&amp; python -m pytest tests/ -v 2&gt;&amp;1 | tail -40</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">tests/test_fall_back.py::TestExecFallback::test_fallback_in_flow PASSED  [ 52%]
tests/test_fall_back.py::TestExecFallback::test_no_fallback_implementation PASSED [ 53%]
tests/test_fall_back.py::TestExecFallback::test_retry_before_fallback PASSED [ 55%]
tests/test_fall_back.py::TestExecFallback::test_successful_execution PASSED [ 56%]
tests/test_fall_back.py::TestAsyncExecFallback::test_async_fallback_after_failure PASSED [ 58%]
tests/test_fall_back.py::TestAsyncExecFallback::test_async_fallback_in_flow PASSED [ 60%]
tests/test_fall_back.py::TestAsyncExecFallback::test_async_no_fallback_implementation PASSED [ 61%]
tests/test_fall_back.py::TestAsyncExecFallback::test_async_retry_before_fallback PASSED [ 63%]
tests/test_fall_back.py::TestAsyncExecFallback::test_async_successful_execution PASSED [ 64%]
tests/test_fastapi_integration.py::TestMountFlow::test_async_flow_run PASSED [ 66%]
tests/test_fastapi_integration.py::TestMountFlow::test_custom_error_handler PASSED [ 67%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_metrics PASSED [ 69%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_streaming PASSED [ 70%]
tests/test_fastapi_integration.py::TestMountFlow::test_error_handling PASSED [ 72%]
tests/test_fastapi_integration.py::TestMountFlow::test_health_endpoint PASSED [ 73%]
tests/test_fastapi_integration.py::TestMountFlow::test_metrics_endpoint PASSED [ 75%]
tests/test_fastapi_integration.py::TestMountFlow::test_prefix PASSED     [ 76%]
tests/test_fastapi_integration.py::TestMountFlow::test_prep_shared_callback PASSED [ 78%]
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint PASSED [ 80%]
tests/test_fastapi_integration.py::TestMountFlow::test_sync_flow_run PASSED [ 81%]
tests/test_flow_basic.py::TestFlowBasic::test_branching_negative PASSED  [ 83%]
tests/test_flow_basic.py::TestFlowBasic::test_branching_positive PASSED  [ 84%]
tests/test_flow_basic.py::TestFlowBasic::test_cycle_until_negative_ends_with_signal PASSED [ 86%]
tests/test_flow_basic.py::TestFlowBasic::test_flow_ends_warning_default_missing PASSED [ 87%]
tests/test_flow_basic.py::TestFlowBasic::test_flow_ends_warning_specific_missing PASSED [ 89%]
tests/test_flow_basic.py::TestFlowBasic::test_sequence_with_rshift PASSED [ 90%]
tests/test_flow_basic.py::TestFlowBasic::test_start_method_chaining PASSED [ 92%]
tests/test_flow_basic.py::TestFlowBasic::test_start_method_initialization PASSED [ 93%]
tests/test_flow_composition.py::TestFlowComposition::test_composition_with_action_propagation PASSED [ 95%]
tests/test_flow_composition.py::TestFlowComposition::test_flow_as_node PASSED [ 96%]
tests/test_flow_composition.py::TestFlowComposition::test_flow_chaining_flows PASSED [ 98%]
tests/test_flow_composition.py::TestFlowComposition::test_nested_flow PASSED [100%]

=============================== warnings summary ===============================
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint
  /opt/conda/lib/python3.9/asyncio/base_events.py:542: DeprecationWarning: The loop argument is deprecated since Python 3.8, and scheduled for removal in Python 3.10.
    results = await tasks.gather(

-- Docs: https://docs.pytest.org/en/stable/warnings.html
======================== 65 passed, 1 warning in 2.30s =========================</span></div></div><span class="leading-6 whitespace-pre-wrap">
All 65 tests pass. Let me copy the files to the output directory:
</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">mkdir -p /tmp/outputs &amp;&amp; cp -r /tmp/inputs/PocketFlow/pocketflow /tmp/outputs/ &amp;&amp; cp /tmp/inputs/PocketFlow/tests/test_fastapi_integration.py /tmp/outputs/</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="border border-gray-200 rounded mb-2 text-normal text-gray-900 overflow-x-auto text-amber-700"><span class="leading-6 whitespace-pre-wrap">Tool ran without output or errors</span></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">44K	/tmp/outputs
37K	/tmp/outputs/pocketflow
5.5K	/tmp/outputs/pocketflow/__init__.py
5.5K	/tmp/outputs/pocketflow/__init__.pyi
18K	/tmp/outputs/pocketflow/__pycache__
8.0K	/tmp/outputs/pocketflow/fastapi.py
7.0K	/tmp/outputs/test_fastapi_integration.py
</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">rm -rf /tmp/outputs/pocketflow/__pycache__</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="border border-gray-200 rounded mb-2 text-normal text-gray-900 overflow-x-auto text-amber-700"><span class="leading-6 whitespace-pre-wrap">Tool ran without output or errors</span></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/__init__.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	import asyncio, warnings, copy, time
     2	
     3	def __getattr__(name):
     4	    if name in ("mount_flow", "stream_event"):
     5	        from .fastapi import mount_flow, stream_event
     6	        return mount_flow if name == "mount_flow" else stream_event
     7	    raise AttributeError(f"module {__name__!r} has no attribute {name!r}")
     8	
     9	class BaseNode:
    10	    def __init__(self): self.params,self.successors={},{}
    11	    def set_params(self,params): self.params=params
    12	    def next(self,node,action="default"):
    13	        if action in self.successors: warnings.warn(f"Overwriting successor for action '{action}'")
    14	        self.successors[action]=node; return node
    15	    def prep(self,shared): pass
    16	    def exec(self,prep_res): pass
    17	    def post(self,shared,prep_res,exec_res): pass
    18	    def _exec(self,prep_res): return self.exec(prep_res)
    19	    def _run(self,shared): p=self.prep(shared); e=self._exec(p); return self.post(shared,p,e)
    20	    def run(self,shared): 
    21	        if self.successors: warnings.warn("Node won't run successors. Use Flow.")  
    22	        return self._run(shared)
    23	    def __rshift__(self,other): return self.next(other)
    24	    def __sub__(self,action):
    25	        if isinstance(action,str): return _ConditionalTransition(self,action)
    26	        raise TypeError("Action must be a string")
    27	
    28	class _ConditionalTransition:
    29	    def __init__(self,src,action): self.src,self.action=src,action
    30	    def __rshift__(self,tgt): return self.src.next(tgt,self.action)
    31	
    32	class Node(BaseNode):
    33	    def __init__(self,max_retries=1,wait=0): super().__init__(); self.max_retries,self.wait=max_retries,wait
    34	    def exec_fallback(self,prep_res,exc): raise exc
    35	    def _exec(self,prep_res):
    36	        for self.cur_retry in range(self.max_retries):
    37	            try: return self.exec(prep_res)
    38	            except Exception as e:
    39	                if self.cur_retry==self.max_retries-1: return self.exec_fallback(prep_res,e)
    40	                if self.wait&gt;0: time.sleep(self.wait)
    41	
    42	class BatchNode(Node):
    43	    def _exec(self,items): return [super(BatchNode,self)._exec(i) for i in (items or [])]
    44	
    45	class Flow(BaseNode):
    46	    def __init__(self,start=None): super().__init__(); self.start_node=start
    47	    def start(self,start): self.start_node=start; return start
    48	    def get_next_node(self,curr,action):
    49	        nxt=curr.successors.get(action or "default")
    50	        if not nxt and curr.successors: warnings.warn(f"Flow ends: '{action}' not found in {list(curr.successors)}")
    51	        return nxt
    52	    def _orch(self,shared,params=None):
    53	        curr,p,last_action =copy.copy(self.start_node),(params or {**self.params}),None
    54	        while curr: curr.set_params(p); last_action=curr._run(shared); curr=copy.copy(self.get_next_node(curr,last_action))
    55	        return last_action
    56	    def _run(self,shared): p=self.prep(shared); o=self._orch(shared); return self.post(shared,p,o)
    57	    def post(self,shared,prep_res,exec_res): return exec_res
    58	
    59	class BatchFlow(Flow):
    60	    def _run(self,shared):
    61	        pr=self.prep(shared) or []
    62	        for bp in pr: self._orch(shared,{**self.params,**bp})
    63	        return self.post(shared,pr,None)
    64	
    65	class AsyncNode(Node):
    66	    async def prep_async(self,shared): pass
    67	    async def exec_async(self,prep_res): pass
    68	    async def exec_fallback_async(self,prep_res,exc): raise exc
    69	    async def post_async(self,shared,prep_res,exec_res): pass
    70	    async def _exec(self,prep_res): 
    71	        for self.cur_retry in range(self.max_retries):
    72	            try: return await self.exec_async(prep_res)
    73	            except Exception as e:
    74	                if self.cur_retry==self.max_retries-1: return await self.exec_fallback_async(prep_res,e)
    75	                if self.wait&gt;0: await asyncio.sleep(self.wait)
    76	    async def run_async(self,shared): 
    77	        if self.successors: warnings.warn("Node won't run successors. Use AsyncFlow.")  
    78	        return await self._run_async(shared)
    79	    async def _run_async(self,shared): p=await self.prep_async(shared); e=await self._exec(p); return await self.post_async(shared,p,e)
    80	    def _run(self,shared): raise RuntimeError("Use run_async.")
    81	
    82	class AsyncBatchNode(AsyncNode,BatchNode):
    83	    async def _exec(self,items): return [await super(AsyncBatchNode,self)._exec(i) for i in items]
    84	
    85	class AsyncParallelBatchNode(AsyncNode,BatchNode):
    86	    async def _exec(self,items): return await asyncio.gather(*(super(AsyncParallelBatchNode,self)._exec(i) for i in items))
    87	
    88	class AsyncFlow(Flow,AsyncNode):
    89	    async def _orch_async(self,shared,params=None):
    90	        curr,p,last_action =copy.copy(self.start_node),(params or {**self.params}),None
    91	        while curr: curr.set_params(p); last_action=await curr._run_async(shared) if isinstance(curr,AsyncNode) else curr._run(shared); curr=copy.copy(self.get_next_node(curr,last_action))
    92	        return last_action
    93	    async def _run_async(self,shared): p=await self.prep_async(shared); o=await self._orch_async(shared); return await self.post_async(shared,p,o)
    94	    async def post_async(self,shared,prep_res,exec_res): return exec_res
    95	
    96	class AsyncBatchFlow(AsyncFlow,BatchFlow):
    97	    async def _run_async(self,shared):
    98	        pr=await self.prep_async(shared) or []
    99	        for bp in pr: await self._orch_async(shared,{**self.params,**bp})
   100	        return await self.post_async(shared,pr,None)
   101	
   102	class AsyncParallelBatchFlow(AsyncFlow,BatchFlow):
   103	    async def _run_async(self,shared): 
   104	        pr=await self.prep_async(shared) or []
   105	        await asyncio.gather(*(self._orch_async(shared,{**self.params,**bp}) for bp in pr))
   106	        return await self.post_async(shared,pr,None)</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	"""
     2	FastAPI integration for PocketFlow.
     3	
     4	Provides mount_flow() helper to automatically register routes for running flows.
     5	"""
     6	
     7	import asyncio
     8	import json
     9	import time
    10	from typing import Any, Callable, Optional, Union
    11	from dataclasses import dataclass, field
    12	
    13	try:
    14	    from fastapi import APIRouter, HTTPException, Request
    15	    from fastapi.responses import StreamingResponse
    16	    from pydantic import BaseModel
    17	except ImportError:
    18	    raise ImportError(
    19	        "FastAPI integration requires fastapi and pydantic. "
    20	        "Install with: pip install fastapi pydantic"
    21	    )
    22	
    23	from . import Flow, AsyncFlow
    24	
    25	
    26	class RunRequest(BaseModel):
    27	    shared: dict = {}
    28	    params: dict = {}
    29	
    30	
    31	class RunResponse(BaseModel):
    32	    result: Any
    33	    shared: dict
    34	
    35	
    36	@dataclass
    37	class FlowMetrics:
    38	    total_runs: int = 0
    39	    successful_runs: int = 0
    40	    failed_runs: int = 0
    41	    total_time_ms: float = 0.0
    42	    last_run_time_ms: float = 0.0
    43	    last_error: Optional[str] = None
    44	
    45	
    46	_metrics_store: dict[str, FlowMetrics] = {}
    47	
    48	
    49	def mount_flow(
    50	    flow: Union[Flow, AsyncFlow],
    51	    *,
    52	    prefix: str = "",
    53	    name: str = "flow",
    54	    enable_streaming: bool = True,
    55	    enable_metrics: bool = True,
    56	    prep_shared: Optional[Callable[[dict], dict]] = None,
    57	    on_error: Optional[Callable[[Exception], Any]] = None,
    58	) -&gt; APIRouter:
    59	    """
    60	    Create a FastAPI router with routes for running a PocketFlow flow.
    61	
    62	    Args:
    63	        flow: A Flow or AsyncFlow instance to mount.
    64	        prefix: URL prefix for all routes (e.g., "/api/v1").
    65	        name: Name used in metrics and route tags.
    66	        enable_streaming: Whether to enable the /stream endpoint.
    67	        enable_metrics: Whether to enable the /metrics endpoint.
    68	        prep_shared: Optional function to preprocess shared dict before running.
    69	        on_error: Optional error handler function.
    70	
    71	    Returns:
    72	        APIRouter with /run, /stream (optional), /metrics (optional), and /health routes.
    73	
    74	    Example:
    75	        from pocketflow import Flow, AsyncFlow
    76	        from pocketflow.fastapi import mount_flow
    77	        from fastapi import FastAPI
    78	
    79	        app = FastAPI()
    80	        my_flow = Flow(start=my_node)
    81	        app.include_router(mount_flow(my_flow, prefix="/workflow"))
    82	    """
    83	    router = APIRouter(prefix=prefix, tags=[name])
    84	    is_async = isinstance(flow, AsyncFlow)
    85	
    86	    if name not in _metrics_store:
    87	        _metrics_store[name] = FlowMetrics()
    88	
    89	    def get_metrics() -&gt; FlowMetrics:
    90	        return _metrics_store[name]
    91	
    92	    def update_metrics(success: bool, duration_ms: float, error: Optional[str] = None):
    93	        m = get_metrics()
    94	        m.total_runs += 1
    95	        m.total_time_ms += duration_ms
    96	        m.last_run_time_ms = duration_ms
    97	        if success:
    98	            m.successful_runs += 1
    99	        else:
   100	            m.failed_runs += 1
   101	            m.last_error = error
   102	
   103	    def handle_error(e: Exception) -&gt; dict:
   104	        if on_error:
   105	            return on_error(e)
   106	        return {"error": str(e), "type": type(e).__name__}
   107	
   108	    @router.post("/run", response_model=RunResponse)
   109	    async def run_flow(request: RunRequest):
   110	        shared = dict(request.shared)
   111	        if prep_shared:
   112	            shared = prep_shared(shared)
   113	
   114	        if request.params:
   115	            flow.set_params(request.params)
   116	
   117	        start_time = time.perf_counter()
   118	        try:
   119	            if is_async:
   120	                result = await flow.run_async(shared)
   121	            else:
   122	                result = await asyncio.to_thread(flow.run, shared)
   123	            duration_ms = (time.perf_counter() - start_time) * 1000
   124	            if enable_metrics:
   125	                update_metrics(True, duration_ms)
   126	            return RunResponse(result=result, shared=shared)
   127	        except Exception as e:
   128	            duration_ms = (time.perf_counter() - start_time) * 1000
   129	            if enable_metrics:
   130	                update_metrics(False, duration_ms, str(e))
   131	            raise HTTPException(status_code=500, detail=handle_error(e))
   132	
   133	    if enable_streaming:
   134	
   135	        @router.post("/stream")
   136	        async def stream_flow(request: RunRequest):
   137	            shared = dict(request.shared)
   138	            if prep_shared:
   139	                shared = prep_shared(shared)
   140	
   141	            if request.params:
   142	                flow.set_params(request.params)
   143	
   144	            stream_queue: asyncio.Queue = asyncio.Queue()
   145	            shared["_stream_queue"] = stream_queue
   146	
   147	            async def run_and_signal():
   148	                start_time = time.perf_counter()
   149	                try:
   150	                    if is_async:
   151	                        result = await flow.run_async(shared)
   152	                    else:
   153	                        result = await asyncio.to_thread(flow.run, shared)
   154	                    duration_ms = (time.perf_counter() - start_time) * 1000
   155	                    if enable_metrics:
   156	                        update_metrics(True, duration_ms)
   157	                    await stream_queue.put({"type": "complete", "result": result})
   158	                except Exception as e:
   159	                    duration_ms = (time.perf_counter() - start_time) * 1000
   160	                    if enable_metrics:
   161	                        update_metrics(False, duration_ms, str(e))
   162	                    await stream_queue.put({"type": "error", "error": str(e)})
   163	
   164	            async def event_generator():
   165	                task = asyncio.create_task(run_and_signal())
   166	                try:
   167	                    while True:
   168	                        try:
   169	                            msg = await asyncio.wait_for(stream_queue.get(), timeout=30.0)
   170	                            yield f"data: {json.dumps(msg)}\n\n"
   171	                            if msg.get("type") in ("complete", "error"):
   172	                                break
   173	                        except asyncio.TimeoutError:
   174	                            yield f"data: {json.dumps({'type': 'keepalive'})}\n\n"
   175	                finally:
   176	                    if not task.done():
   177	                        task.cancel()
   178	                        try:
   179	                            await task
   180	                        except asyncio.CancelledError:
   181	                            pass
   182	
   183	            return StreamingResponse(
   184	                event_generator(),
   185	                media_type="text/event-stream",
   186	                headers={
   187	                    "Cache-Control": "no-cache",
   188	                    "Connection": "keep-alive",
   189	                    "X-Accel-Buffering": "no",
   190	                },
   191	            )
   192	
   193	    if enable_metrics:
   194	
   195	        @router.get("/metrics")
   196	        async def get_flow_metrics():
   197	            m = get_metrics()
   198	            avg_time = m.total_time_ms / m.total_runs if m.total_runs &gt; 0 else 0
   199	            return {
   200	                "name": name,
   201	                "total_runs": m.total_runs,
   202	                "successful_runs": m.successful_runs,
   203	                "failed_runs": m.failed_runs,
   204	                "success_rate": m.successful_runs / m.total_runs if m.total_runs &gt; 0 else 0,
   205	                "avg_time_ms": avg_time,
   206	                "last_run_time_ms": m.last_run_time_ms,
   207	                "last_error": m.last_error,
   208	            }
   209	
   210	    @router.get("/health")
   211	    async def health_check():
   212	        return {"status": "healthy", "flow": name, "type": "async" if is_async else "sync"}
   213	
   214	    return router
   215	
   216	
   217	def stream_event(shared: dict, event_type: str, data: Any):
   218	    """
   219	    Helper function to send a streaming event from within a node.
   220	
   221	    Use this inside your node's exec/exec_async method to push events to the stream.
   222	
   223	    Args:
   224	        shared: The shared dict passed to the node.
   225	        event_type: A string identifying the event type (e.g., "progress", "token").
   226	        data: The event data to send.
   227	
   228	    Example:
   229	        class MyNode(AsyncNode):
   230	            async def exec_async(self, prep_res):
   231	                for i in range(10):
   232	                    stream_event(self.shared, "progress", {"step": i})
   233	                    await asyncio.sleep(0.1)
   234	    """
   235	    queue = shared.get("_stream_queue")
   236	    if queue is not None:
   237	        try:
   238	            queue.put_nowait({"type": event_type, "data": data})
   239	        except Exception:
   240	            pass
   241	</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/test_fastapi_integration.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	import unittest
     2	import asyncio
     3	import sys
     4	from pathlib import Path
     5	
     6	sys.path.insert(0, str(Path(__file__).parent.parent))
     7	
     8	try:
     9	    from fastapi import FastAPI
    10	    from fastapi.testclient import TestClient
    11	    FASTAPI_AVAILABLE = True
    12	except ImportError:
    13	    FASTAPI_AVAILABLE = False
    14	
    15	from pocketflow import Node, AsyncNode, Flow, AsyncFlow
    16	
    17	
    18	class AddNumberNode(Node):
    19	    def __init__(self, number):
    20	        super().__init__()
    21	        self.number = number
    22	
    23	    def prep(self, shared):
    24	        shared["result"] = shared.get("result", 0) + self.number
    25	
    26	
    27	class AsyncAddNode(AsyncNode):
    28	    def __init__(self, number):
    29	        super().__init__()
    30	        self.number = number
    31	
    32	    async def prep_async(self, shared):
    33	        await asyncio.sleep(0.01)
    34	        shared["result"] = shared.get("result", 0) + self.number
    35	
    36	
    37	class ErrorNode(Node):
    38	    def prep(self, shared):
    39	        raise ValueError("Intentional error")
    40	
    41	
    42	class StreamingNode(AsyncNode):
    43	    async def exec_async(self, prep_res):
    44	        from pocketflow.fastapi import stream_event
    45	        shared = self.params.get("_shared", {})
    46	        for i in range(3):
    47	            stream_event(shared, "progress", {"step": i})
    48	            await asyncio.sleep(0.01)
    49	        return "done"
    50	
    51	
    52	@unittest.skipUnless(FASTAPI_AVAILABLE, "FastAPI not installed")
    53	class TestMountFlow(unittest.TestCase):
    54	
    55	    def test_sync_flow_run(self):
    56	        from pocketflow.fastapi import mount_flow
    57	
    58	        node1 = AddNumberNode(10)
    59	        node2 = AddNumberNode(5)
    60	        node1 &gt;&gt; node2
    61	        flow = Flow(start=node1)
    62	
    63	        app = FastAPI()
    64	        app.include_router(mount_flow(flow, name="test_sync"))
    65	
    66	        client = TestClient(app)
    67	        response = client.post("/run", json={"shared": {"result": 0}})
    68	        self.assertEqual(response.status_code, 200)
    69	        data = response.json()
    70	        self.assertEqual(data["shared"]["result"], 15)
    71	
    72	    def test_async_flow_run(self):
    73	        from pocketflow.fastapi import mount_flow
    74	
    75	        node1 = AsyncAddNode(20)
    76	        node2 = AsyncAddNode(10)
    77	        node1 &gt;&gt; node2
    78	        flow = AsyncFlow(start=node1)
    79	
    80	        app = FastAPI()
    81	        app.include_router(mount_flow(flow, name="test_async"))
    82	
    83	        client = TestClient(app)
    84	        response = client.post("/run", json={"shared": {"result": 5}})
    85	        self.assertEqual(response.status_code, 200)
    86	        data = response.json()
    87	        self.assertEqual(data["shared"]["result"], 35)
    88	
    89	    def test_health_endpoint(self):
    90	        from pocketflow.fastapi import mount_flow
    91	
    92	        flow = Flow(start=AddNumberNode(1))
    93	        app = FastAPI()
    94	        app.include_router(mount_flow(flow, name="health_test"))
    95	
    96	        client = TestClient(app)
    97	        response = client.get("/health")
    98	        self.assertEqual(response.status_code, 200)
    99	        data = response.json()
   100	        self.assertEqual(data["status"], "healthy")
   101	        self.assertEqual(data["flow"], "health_test")
   102	        self.assertEqual(data["type"], "sync")
   103	
   104	    def test_metrics_endpoint(self):
   105	        from pocketflow.fastapi import mount_flow
   106	
   107	        flow = Flow(start=AddNumberNode(1))
   108	        app = FastAPI()
   109	        app.include_router(mount_flow(flow, name="metrics_test"))
   110	
   111	        client = TestClient(app)
   112	        client.post("/run", json={"shared": {}})
   113	        client.post("/run", json={"shared": {}})
   114	
   115	        response = client.get("/metrics")
   116	        self.assertEqual(response.status_code, 200)
   117	        data = response.json()
   118	        self.assertEqual(data["name"], "metrics_test")
   119	        self.assertGreaterEqual(data["total_runs"], 2)
   120	        self.assertGreaterEqual(data["successful_runs"], 2)
   121	
   122	    def test_error_handling(self):
   123	        from pocketflow.fastapi import mount_flow
   124	
   125	        flow = Flow(start=ErrorNode())
   126	        app = FastAPI()
   127	        app.include_router(mount_flow(flow, name="error_test"))
   128	
   129	        client = TestClient(app)
   130	        response = client.post("/run", json={"shared": {}})
   131	        self.assertEqual(response.status_code, 500)
   132	        data = response.json()
   133	        self.assertIn("error", data["detail"])
   134	
   135	    def test_prefix(self):
   136	        from pocketflow.fastapi import mount_flow
   137	
   138	        flow = Flow(start=AddNumberNode(1))
   139	        app = FastAPI()
   140	        app.include_router(mount_flow(flow, prefix="/api/v1", name="prefix_test"))
   141	
   142	        client = TestClient(app)
   143	        response = client.get("/api/v1/health")
   144	        self.assertEqual(response.status_code, 200)
   145	
   146	    def test_prep_shared_callback(self):
   147	        from pocketflow.fastapi import mount_flow
   148	
   149	        def prep_shared(shared):
   150	            shared["injected"] = True
   151	            return shared
   152	
   153	        flow = Flow(start=AddNumberNode(1))
   154	        app = FastAPI()
   155	        app.include_router(mount_flow(flow, name="prep_test", prep_shared=prep_shared))
   156	
   157	        client = TestClient(app)
   158	        response = client.post("/run", json={"shared": {}})
   159	        self.assertEqual(response.status_code, 200)
   160	        data = response.json()
   161	        self.assertTrue(data["shared"]["injected"])
   162	
   163	    def test_stream_endpoint(self):
   164	        from pocketflow.fastapi import mount_flow
   165	
   166	        flow = Flow(start=AddNumberNode(1))
   167	        app = FastAPI()
   168	        app.include_router(mount_flow(flow, name="stream_test", enable_streaming=True))
   169	
   170	        client = TestClient(app)
   171	        response = client.post("/stream", json={"shared": {}})
   172	        self.assertEqual(response.status_code, 200)
   173	        self.assertIn("complete", response.text)
   174	
   175	    def test_disabled_streaming(self):
   176	        from pocketflow.fastapi import mount_flow
   177	
   178	        flow = Flow(start=AddNumberNode(1))
   179	        app = FastAPI()
   180	        app.include_router(mount_flow(flow, name="no_stream", enable_streaming=False))
   181	
   182	        client = TestClient(app)
   183	        response = client.post("/stream", json={"shared": {}})
   184	        self.assertEqual(response.status_code, 404)
   185	
   186	    def test_disabled_metrics(self):
   187	        from pocketflow.fastapi import mount_flow
   188	
   189	        flow = Flow(start=AddNumberNode(1))
   190	        app = FastAPI()
   191	        app.include_router(mount_flow(flow, name="no_metrics", enable_metrics=False))
   192	
   193	        client = TestClient(app)
   194	        response = client.get("/metrics")
   195	        self.assertEqual(response.status_code, 404)
   196	
   197	    def test_custom_error_handler(self):
   198	        from pocketflow.fastapi import mount_flow
   199	
   200	        def custom_error_handler(e):
   201	            return {"custom_error": True, "message": str(e)}
   202	
   203	        flow = Flow(start=ErrorNode())
   204	        app = FastAPI()
   205	        app.include_router(mount_flow(flow, name="custom_err", on_error=custom_error_handler))
   206	
   207	        client = TestClient(app)
   208	        response = client.post("/run", json={"shared": {}})
   209	        self.assertEqual(response.status_code, 500)
   210	        data = response.json()
   211	        self.assertTrue(data["detail"]["custom_error"])
   212	
   213	
   214	if __name__ == "__main__":
   215	    unittest.main()
   216	</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/__init__.pyi</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	import asyncio
     2	from typing import Any, Dict, List, Optional, Union, TypeVar, Generic
     3	
     4	# Type variables for better type relationships
     5	_PrepResult = TypeVar('_PrepResult')
     6	_ExecResult = TypeVar('_ExecResult')
     7	_PostResult = TypeVar('_PostResult')
     8	
     9	# More specific parameter types
    10	ParamValue = Union[str, int, float, bool, None, List[Any], Dict[str, Any]]
    11	SharedData = Dict[str, Any]
    12	Params = Dict[str, ParamValue]
    13	
    14	class BaseNode(Generic[_PrepResult, _ExecResult, _PostResult]):
    15	    params: Params
    16	    successors: Dict[str, BaseNode[Any, Any, Any]]
    17	    
    18	    def __init__(self) -&gt; None: ...
    19	    def set_params(self, params: Params) -&gt; None: ...
    20	    def next(self, node: BaseNode[Any, Any, Any], action: str = "default") -&gt; BaseNode[Any, Any, Any]: ...
    21	    def prep(self, shared: SharedData) -&gt; _PrepResult: ...
    22	    def exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    23	    def post(self, shared: SharedData, prep_res: _PrepResult, exec_res: _ExecResult) -&gt; _PostResult: ...
    24	    def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    25	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    26	    def run(self, shared: SharedData) -&gt; _PostResult: ...
    27	    def __rshift__(self, other: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    28	    def __sub__(self, action: str) -&gt; _ConditionalTransition: ...
    29	
    30	class _ConditionalTransition:
    31	    src: BaseNode[Any, Any, Any]
    32	    action: str
    33	    
    34	    def __init__(self, src: BaseNode[Any, Any, Any], action: str) -&gt; None: ...
    35	    def __rshift__(self, tgt: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    36	
    37	class Node(BaseNode[_PrepResult, _ExecResult, _PostResult]):
    38	    max_retries: int
    39	    wait: Union[int, float]
    40	    cur_retry: int
    41	    
    42	    def __init__(self, max_retries: int = 1, wait: Union[int, float] = 0) -&gt; None: ...
    43	    def exec_fallback(self, prep_res: _PrepResult, exc: Exception) -&gt; _ExecResult: ...
    44	    def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    45	
    46	class BatchNode(Node[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    47	    def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    48	
    49	class Flow(BaseNode[_PrepResult, Any, _PostResult]):
    50	    start_node: Optional[BaseNode[Any, Any, Any]]
    51	    
    52	    def __init__(self, start: Optional[BaseNode[Any, Any, Any]] = None) -&gt; None: ...
    53	    def start(self, start: BaseNode[Any, Any, Any]) -&gt; BaseNode[Any, Any, Any]: ...
    54	    def get_next_node(
    55	        self, curr: BaseNode[Any, Any, Any], action: Optional[str]
    56	    ) -&gt; Optional[BaseNode[Any, Any, Any]]: ...
    57	    def _orch(
    58	        self, shared: SharedData, params: Optional[Params] = None
    59	    ) -&gt; Any: ...
    60	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    61	    def post(self, shared: SharedData, prep_res: _PrepResult, exec_res: Any) -&gt; _PostResult: ...
    62	
    63	class BatchFlow(Flow[Optional[List[Params]], Any, _PostResult]):
    64	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    65	
    66	class AsyncNode(Node[_PrepResult, _ExecResult, _PostResult]):
    67	    async def prep_async(self, shared: SharedData) -&gt; _PrepResult: ...
    68	    async def exec_async(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    69	    async def exec_fallback_async(self, prep_res: _PrepResult, exc: Exception) -&gt; _ExecResult: ...
    70	    async def post_async(
    71	        self, shared: SharedData, prep_res: _PrepResult, exec_res: _ExecResult
    72	    ) -&gt; _PostResult: ...
    73	    async def _exec(self, prep_res: _PrepResult) -&gt; _ExecResult: ...
    74	    async def run_async(self, shared: SharedData) -&gt; _PostResult: ...
    75	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    76	    def _run(self, shared: SharedData) -&gt; _PostResult: ...
    77	
    78	class AsyncBatchNode(AsyncNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult], BatchNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    79	    async def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    80	
    81	class AsyncParallelBatchNode(AsyncNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult], BatchNode[Optional[List[_PrepResult]], List[_ExecResult], _PostResult]):
    82	    async def _exec(self, items: Optional[List[_PrepResult]]) -&gt; List[_ExecResult]: ...
    83	
    84	class AsyncFlow(Flow[_PrepResult, Any, _PostResult], AsyncNode[_PrepResult, Any, _PostResult]):
    85	    async def _orch_async(
    86	        self, shared: SharedData, params: Optional[Params] = None
    87	    ) -&gt; Any: ...
    88	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    89	    async def post_async(
    90	        self, shared: SharedData, prep_res: _PrepResult, exec_res: Any
    91	    ) -&gt; _PostResult: ...
    92	
    93	class AsyncBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    94	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    95	
    96	class AsyncParallelBatchFlow(AsyncFlow[Optional[List[Params]], Any, _PostResult], BatchFlow[Optional[List[Params]], Any, _PostResult]):
    97	    async def _run_async(self, shared: SharedData) -&gt; _PostResult: ...
    98	
    99	# FastAPI integration (lazy loaded)
   100	def mount_flow(
   101	    flow: Union[Flow[Any, Any, Any], AsyncFlow[Any, Any, Any]],
   102	    *,
   103	    prefix: str = "",
   104	    name: str = "flow",
   105	    enable_streaming: bool = True,
   106	    enable_metrics: bool = True,
   107	    prep_shared: Optional[Any] = None,
   108	    on_error: Optional[Any] = None,
   109	) -&gt; Any: ...
   110	
   111	def stream_event(shared: SharedData, event_type: str, data: Any) -&gt; None: ...</span></div></div><span class="leading-6 whitespace-pre-wrap">
The implementation is complete. Here's a summary of what was added:

**New file: `pocketflow/fastapi.py`**
- `mount_flow()` - Creates a FastAPI router with `/run`, `/stream`, `/metrics`, and `/health` endpoints
- `stream_event()` - Helper to push streaming events from within nodes

**Modified files:**
- `pocketflow/__init__.py` - Added lazy loading for `mount_flow` and `stream_event`
- `pocketflow/__init__.pyi` - Added type stubs for the new functions

**Key features:**
- Supports both `Flow` and `AsyncFlow` (sync flows run in a thread pool)
- SSE streaming with keepalive and proper cleanup
- Metrics tracking (runs, success rate, timing, last error)
- Configurable prefix, name, streaming, and metrics
- `prep_shared` callback to inject data before running
- `on_error` callback for custom error handling
- Health check endpoint</span></div><div class="place-self-end"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="Green" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"></path></svg></div></div><div class="mt-1.5 text-sm text-gray-500 flex-col"><hr class="h-px my-2 bg-gray-200 border-0 dark:bg-gray-700"><a href="https://feedback-blob.s3.us-east-1.amazonaws.com/attachments/e82d7472-831e-4a9b-8ca7-5c2ffce96a9e/outputs/2026-02-27-13%3A25%3A20-395a60e0/PocketFlow.tar?AWSAccessKeyId=ASIAVP5UUZFZUOPZP5C2&amp;Signature=srRKYNtylcJRjxS%2FbHqkXbYM%2FjY%3D&amp;x-amz-security-token=IQoJb3JpZ2luX2VjEHUaCXVzLWVhc3QtMiJHMEUCIAJYje05xbKP195HmRLTWAzW%2F0U9zmEgk2EPAnTRtY1SAiEA8GjCSVESiWYksganSXezzcDNYzuJUm4ZYNDsCqSddQUqhwUIPxAAGgwzNzc3OTkxMDA3ODciDE1ZCIV1nC%2BqAHzo1CrkBJZrJiZh9h0Ve9u1AzPBNZ5fRc9p2Y1TLJT96yKi60JlakvnN6CjNIxzFytI75Awmgjyz14a0MCwxlSBYOiz9vn1x6humux6nK8gU3GrazTb0eKtIt1VQZPO%2FfglthPQxk2QmYBc4uitwg%2FYDU9rCwUj2r71fJLBgoPeCWT7XzcbMVt9vvu9nOLDjQ1gZGh2uES99UeYNj4UP78dEsbduhSIt6rBksj4TgAdDkHC4Efmv7Vuey6yACj7m9Vu%2FEwD0tcerZBE6CcJ1g0CrGDs1Q4VqsBRB2iMw6B%2F8a98tLJDQnFo0p9AbmoEHuohbzhAMvYbF3KoO%2BP30LYh5lihWRrLYwJl0%2BgpdFf4H74%2Bld6DyRbRP3f7IcmHNmWwSZKTPDk%2BiNJsIPBb6pMfm9oJMRicYToeDwbi6AxH%2FlFvrbuGq9EuZ0JhBiXZRZsT0EkCnBNsAxr5qGjDdyplFgzLDFTpz%2B8UBBh3FdTl2NRa%2BGPT3wORstvTDpxTVsYjYOKteatM0nfc6NegGnUeCi2bXbL3%2Bxt8qRb12WbE8IyzalK4KsliIDkUhkS70XhUP4Ws2oALDnPUcgzo6nGDW%2B28xLcst5f2Cqb351DobtFJnaQ6ITrIZJWK1fHtE%2BM9jCUM%2F87pabeMiA7X1aM8ZPQW6TvF8ffYC8lIdK%2Bnjm09dsc2qPBz6oTPajSCTFOm1N5dbl5afep8109kJ1Ot9Hai2eCVb5TsopGwRaM22zbrId7aXUMh4Hi4EV6W97xBt9i13BgckTO9TGQmddxLC27JPenFfrZb688nYz7owdN2u6mA0kYRCzCdtYbNBjqVAc%2BnT6s7h5S0wSiM6o3YF1lkLkQZ4OCu1ENtCnLABecPKQ7fIxuT%2BA9mEr1mum%2B1h46CdOMjC7f4reLIfdXMC%2FXOOaKEvvomu2tgzW1ataK%2F3quG9Znu4cH8BPxDBPdtKmg02%2FAO46KSmBrp2dcSHLllEH1hY3gB79pNvvOeW8bfGoGrMzgd%2B1zKgkNkFRlDRFD3DCGb&amp;Expires=1772717276" download=""><button class="inline-flex items-center gap-2 rounded-md px-4 py-2 text-sm text-gray-500 hover:text-gray-700 focus:relative overflow-hidden rounded-md border bg-white shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg>PocketFlow.tar</button></a></div></div></div></div></div></div></div><div class="bg-white z-10 absolute -top-4 right-0"><div aria-label="Mark this assistant interaction as especially #GOOD or #BAD" class=""><span class="cursor-pointer"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ThumbDownOffAltIcon"><path d="m10.89 18.28.57-2.89c.12-.59-.04-1.2-.42-1.66-.38-.46-.94-.73-1.54-.73H4v-1.08L6.57 6h8.09c.18 0 .34.16.34.34v7.84l-4.11 4.1M10 22l6.41-6.41c.38-.38.59-.89.59-1.42V6.34C17 5.05 15.95 4 14.66 4h-8.1c-.71 0-1.36.37-1.72.97l-2.67 6.15c-.11.25-.17.52-.17.8V13c0 1.1.9 2 2 2h5.5l-.92 4.65c-.05.22-.02.46.08.66.23.45.52.86.88 1.22L10 22zm10-7h2V4h-2c-.55 0-1 .45-1 1v9c0 .55.45 1 1 1z"></path></svg></span><span class="cursor-pointer"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ThumbUpOffAltIcon"><path d="m13.11 5.72-.57 2.89c-.12.59.04 1.2.42 1.66.38.46.94.73 1.54.73H20v1.08L17.43 18H9.34c-.18 0-.34-.16-.34-.34V9.82l4.11-4.1M14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.83C7 18.95 8.05 20 9.34 20h8.1c.71 0 1.36-.37 1.72-.97l2.67-6.15c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2zM4 9H2v11h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1z"></path></svg></span></div></div></div></div></li><li class="px-3 pt-3 "><div class="relative"><div class="relative flex space-x-3"><span class="css-v87e6z">ðŸ§‘</span><div class="flex-col w-full"><p class="text-sm"><span class="font-medium capitalize flex text-gray-900">Human</span></p><div class="text-sm text-gray-500 w-full flex flex-row"><div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4"><div class="w-full"><div class="whitespace-pre-wrap">FlowMetrics has no threading.Lock â€” add one and wrap every counter mutation in with self._lock. Return only the updated pocketflow/fastapi.py.</div></div></div></div><div class="flex-row w-full overflow-x-auto"><div class="flex-row w-full overflow-x-auto"></div></div></div></div></div></li><li class="px-3 pt-3 "><div class="relative"><div class="relative flex space-x-3"><span class="css-v87e6z">ðŸ¤–</span><div class="flex-col w-full"><p class="text-sm"><span class="font-medium capitalize flex text-gray-900">assistant</span></p><div class="text-sm text-gray-500 w-full flex flex-row"><div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4"><div class="w-full"><div class="whitespace-normal"><div class="min-h-[1.50rem] space-y-1.5 w-full"><div class="flex flex-row"><div class="min-w-[96%]"><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">import asyncio
import json
import time
from typing import Any, Callable, Optional, Union
from dataclasses import dataclass, field

try:
    from fastapi import APIRouter, HTTPException, Request
    from fastapi.responses import StreamingResponse
    from pydantic import BaseModel
except ImportError:
    raise ImportError(
        "FastAPI integration requires fastapi and pydantic. "
        "Install with: pip install fastapi pydantic"
    )

from . import Flow, AsyncFlow


class RunRequest(BaseModel):
    shared: dict = {}
    params: dict = {}


class RunResponse(BaseModel):
    result: Any
    shared: dict


@dataclass
class FlowMetrics:
    total_runs: int = 0
    successful_runs: int = 0
    failed_runs: int = 0
    total_time_ms: float = 0.0
    last_run_time_ms: float = 0.0
    last_error: Optional[str] = None


_metrics_store: dict[str, FlowMetrics] = {}</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">import asyncio
import json
import threading
import time
from typing import Any, Callable, Optional, Union

try:
    from fastapi import APIRouter, HTTPException, Request
    from fastapi.responses import StreamingResponse
    from pydantic import BaseModel
except ImportError:
    raise ImportError(
        "FastAPI integration requires fastapi and pydantic. "
        "Install with: pip install fastapi pydantic"
    )

from . import Flow, AsyncFlow


class RunRequest(BaseModel):
    shared: dict = {}
    params: dict = {}


class RunResponse(BaseModel):
    result: Any
    shared: dict


class FlowMetrics:
    def __init__(self):
        self._lock = threading.Lock()
        self.total_runs: int = 0
        self.successful_runs: int = 0
        self.failed_runs: int = 0
        self.total_time_ms: float = 0.0
        self.last_run_time_ms: float = 0.0
        self.last_error: Optional[str] = None

    def record_success(self, duration_ms: float):
        with self._lock:
            self.total_runs += 1
            self.successful_runs += 1
            self.total_time_ms += duration_ms
            self.last_run_time_ms = duration_ms

    def record_failure(self, duration_ms: float, error: str):
        with self._lock:
            self.total_runs += 1
            self.failed_runs += 1
            self.total_time_ms += duration_ms
            self.last_run_time_ms = duration_ms
            self.last_error = error

    def snapshot(self) -&gt; dict:
        with self._lock:
            return {
                "total_runs": self.total_runs,
                "successful_runs": self.successful_runs,
                "failed_runs": self.failed_runs,
                "total_time_ms": self.total_time_ms,
                "last_run_time_ms": self.last_run_time_ms,
                "last_error": self.last_error,
            }


_metrics_store: dict[str, FlowMetrics] = {}
_metrics_store_lock = threading.Lock()</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/outputs/pocketflow/fastapi.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    router = APIRouter(prefix=prefix, tags=[name])
    is_async = isinstance(flow, AsyncFlow)

    if name not in _metrics_store:
        _metrics_store[name] = FlowMetrics()

    def get_metrics() -&gt; FlowMetrics:
        return _metrics_store[name]

    def update_metrics(success: bool, duration_ms: float, error: Optional[str] = None):
        m = get_metrics()
        m.total_runs += 1
        m.total_time_ms += duration_ms
        m.last_run_time_ms = duration_ms
        if success:
            m.successful_runs += 1
        else:
            m.failed_runs += 1
            m.last_error = error

    def handle_error(e: Exception) -&gt; dict:</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    router = APIRouter(prefix=prefix, tags=[name])
    is_async = isinstance(flow, AsyncFlow)

    with _metrics_store_lock:
        if name not in _metrics_store:
            _metrics_store[name] = FlowMetrics()

    def get_metrics() -&gt; FlowMetrics:
        with _metrics_store_lock:
            return _metrics_store[name]

    def handle_error(e: Exception) -&gt; dict:</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/outputs/pocketflow/fastapi.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">        start_time = time.perf_counter()
        try:
            if is_async:
                result = await flow.run_async(shared)
            else:
                result = await asyncio.to_thread(flow.run, shared)
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                update_metrics(True, duration_ms)
            return RunResponse(result=result, shared=shared)
        except Exception as e:
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                update_metrics(False, duration_ms, str(e))
            raise HTTPException(status_code=500, detail=handle_error(e))</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">        start_time = time.perf_counter()
        try:
            if is_async:
                result = await flow.run_async(shared)
            else:
                result = await asyncio.to_thread(flow.run, shared)
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                get_metrics().record_success(duration_ms)
            return RunResponse(result=result, shared=shared)
        except Exception as e:
            duration_ms = (time.perf_counter() - start_time) * 1000
            if enable_metrics:
                get_metrics().record_failure(duration_ms, str(e))
            raise HTTPException(status_code=500, detail=handle_error(e))</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/outputs/pocketflow/fastapi.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">            async def run_and_signal():
                start_time = time.perf_counter()
                try:
                    if is_async:
                        result = await flow.run_async(shared)
                    else:
                        result = await asyncio.to_thread(flow.run, shared)
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        update_metrics(True, duration_ms)
                    await stream_queue.put({"type": "complete", "result": result})
                except Exception as e:
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        update_metrics(False, duration_ms, str(e))
                    await stream_queue.put({"type": "error", "error": str(e)})</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">            async def run_and_signal():
                start_time = time.perf_counter()
                try:
                    if is_async:
                        result = await flow.run_async(shared)
                    else:
                        result = await asyncio.to_thread(flow.run, shared)
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        get_metrics().record_success(duration_ms)
                    await stream_queue.put({"type": "complete", "result": result})
                except Exception as e:
                    duration_ms = (time.perf_counter() - start_time) * 1000
                    if enable_metrics:
                        get_metrics().record_failure(duration_ms, str(e))
                    await stream_queue.put({"type": "error", "error": str(e)})</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/outputs/pocketflow/fastapi.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">str_replace</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">old_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    if enable_metrics:

        @router.get("/metrics")
        async def get_flow_metrics():
            m = get_metrics()
            avg_time = m.total_time_ms / m.total_runs if m.total_runs &gt; 0 else 0
            return {
                "name": name,
                "total_runs": m.total_runs,
                "successful_runs": m.successful_runs,
                "failed_runs": m.failed_runs,
                "success_rate": m.successful_runs / m.total_runs if m.total_runs &gt; 0 else 0,
                "avg_time_ms": avg_time,
                "last_run_time_ms": m.last_run_time_ms,
                "last_error": m.last_error,
            }</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">new_str</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">    if enable_metrics:

        @router.get("/metrics")
        async def get_flow_metrics():
            snapshot = get_metrics().snapshot()
            total = snapshot["total_runs"]
            successful = snapshot["successful_runs"]
            avg_time = snapshot["total_time_ms"] / total if total &gt; 0 else 0
            return {
                "name": name,
                "total_runs": total,
                "successful_runs": successful,
                "failed_runs": snapshot["failed_runs"],
                "success_rate": successful / total if total &gt; 0 else 0,
                "avg_time_ms": avg_time,
                "last_run_time_ms": snapshot["last_run_time_ms"],
                "last_error": snapshot["last_error"],
            }</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">The file /tmp/outputs/pocketflow/fastapi.py has been edited successfully.</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">cd /tmp/inputs/PocketFlow &amp;&amp; cp /tmp/outputs/pocketflow/fastapi.py pocketflow/ &amp;&amp; python -m pytest tests/test_fastapi_integration.py -v 2&gt;&amp;1</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">============================= test session starts ==============================
platform linux -- Python 3.9.7, pytest-6.2.4, py-1.10.0, pluggy-0.13.1 -- /opt/conda/bin/python
cachedir: .pytest_cache
hypothesis profile 'default' -&gt; database=DirectoryBasedExampleDatabase('/tmp/inputs/PocketFlow/.hypothesis/examples')
rootdir: /tmp/inputs/PocketFlow
plugins: reportlog-0.3.0, hypothesis-6.75.3, cov-4.1.0, timeout-2.1.0, anyio-3.7.1
collecting ... collected 11 items

tests/test_fastapi_integration.py::TestMountFlow::test_async_flow_run PASSED [  9%]
tests/test_fastapi_integration.py::TestMountFlow::test_custom_error_handler PASSED [ 18%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_metrics PASSED [ 27%]
tests/test_fastapi_integration.py::TestMountFlow::test_disabled_streaming PASSED [ 36%]
tests/test_fastapi_integration.py::TestMountFlow::test_error_handling PASSED [ 45%]
tests/test_fastapi_integration.py::TestMountFlow::test_health_endpoint PASSED [ 54%]
tests/test_fastapi_integration.py::TestMountFlow::test_metrics_endpoint PASSED [ 63%]
tests/test_fastapi_integration.py::TestMountFlow::test_prefix PASSED     [ 72%]
tests/test_fastapi_integration.py::TestMountFlow::test_prep_shared_callback PASSED [ 81%]
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint PASSED [ 90%]
tests/test_fastapi_integration.py::TestMountFlow::test_sync_flow_run PASSED [100%]

=============================== warnings summary ===============================
tests/test_fastapi_integration.py::TestMountFlow::test_stream_endpoint
  /opt/conda/lib/python3.9/asyncio/base_events.py:542: DeprecationWarning: The loop argument is deprecated since Python 3.8, and scheduled for removal in Python 3.10.
    results = await tasks.gather(

-- Docs: https://docs.pytest.org/en/stable/warnings.html
======================== 11 passed, 1 warning in 1.28s =========================</span></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-call-fragment" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow"></div></div><span class="leading-6 whitespace-pre-wrap">

</span><div class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200"><div class="font-medium rounded-t p-2">output</div><div class="p-2 rounded-b bg-white"><span class="leading-6 whitespace-pre-wrap">     1	"""
     2	FastAPI integration for PocketFlow.
     3	
     4	Provides mount_flow() helper to automatically register routes for running flows.
     5	"""
     6	
     7	import asyncio
     8	import json
     9	import threading
    10	import time
    11	from typing import Any, Callable, Optional, Union
    12	
    13	try:
    14	    from fastapi import APIRouter, HTTPException, Request
    15	    from fastapi.responses import StreamingResponse
    16	    from pydantic import BaseModel
    17	except ImportError:
    18	    raise ImportError(
    19	        "FastAPI integration requires fastapi and pydantic. "
    20	        "Install with: pip install fastapi pydantic"
    21	    )
    22	
    23	from . import Flow, AsyncFlow
    24	
    25	
    26	class RunRequest(BaseModel):
    27	    shared: dict = {}
    28	    params: dict = {}
    29	
    30	
    31	class RunResponse(BaseModel):
    32	    result: Any
    33	    shared: dict
    34	
    35	
    36	class FlowMetrics:
    37	    def __init__(self):
    38	        self._lock = threading.Lock()
    39	        self.total_runs: int = 0
    40	        self.successful_runs: int = 0
    41	        self.failed_runs: int = 0
    42	        self.total_time_ms: float = 0.0
    43	        self.last_run_time_ms: float = 0.0
    44	        self.last_error: Optional[str] = None
    45	
    46	    def record_success(self, duration_ms: float):
    47	        with self._lock:
    48	            self.total_runs += 1
    49	            self.successful_runs += 1
    50	            self.total_time_ms += duration_ms
    51	            self.last_run_time_ms = duration_ms
    52	
    53	    def record_failure(self, duration_ms: float, error: str):
    54	        with self._lock:
    55	            self.total_runs += 1
    56	            self.failed_runs += 1
    57	            self.total_time_ms += duration_ms
    58	            self.last_run_time_ms = duration_ms
    59	            self.last_error = error
    60	
    61	    def snapshot(self) -&gt; dict:
    62	        with self._lock:
    63	            return {
    64	                "total_runs": self.total_runs,
    65	                "successful_runs": self.successful_runs,
    66	                "failed_runs": self.failed_runs,
    67	                "total_time_ms": self.total_time_ms,
    68	                "last_run_time_ms": self.last_run_time_ms,
    69	                "last_error": self.last_error,
    70	            }
    71	
    72	
    73	_metrics_store: dict[str, FlowMetrics] = {}
    74	_metrics_store_lock = threading.Lock()
    75	
    76	
    77	def mount_flow(
    78	    flow: Union[Flow, AsyncFlow],
    79	    *,
    80	    prefix: str = "",
    81	    name: str = "flow",
    82	    enable_streaming: bool = True,
    83	    enable_metrics: bool = True,
    84	    prep_shared: Optional[Callable[[dict], dict]] = None,
    85	    on_error: Optional[Callable[[Exception], Any]] = None,
    86	) -&gt; APIRouter:
    87	    """
    88	    Create a FastAPI router with routes for running a PocketFlow flow.
    89	
    90	    Args:
    91	        flow: A Flow or AsyncFlow instance to mount.
    92	        prefix: URL prefix for all routes (e.g., "/api/v1").
    93	        name: Name used in metrics and route tags.
    94	        enable_streaming: Whether to enable the /stream endpoint.
    95	        enable_metrics: Whether to enable the /metrics endpoint.
    96	        prep_shared: Optional function to preprocess shared dict before running.
    97	        on_error: Optional error handler function.
    98	
    99	    Returns:
   100	        APIRouter with /run, /stream (optional), /metrics (optional), and /health routes.
   101	
   102	    Example:
   103	        from pocketflow import Flow, AsyncFlow
   104	        from pocketflow.fastapi import mount_flow
   105	        from fastapi import FastAPI
   106	
   107	        app = FastAPI()
   108	        my_flow = Flow(start=my_node)
   109	        app.include_router(mount_flow(my_flow, prefix="/workflow"))
   110	    """
   111	    router = APIRouter(prefix=prefix, tags=[name])
   112	    is_async = isinstance(flow, AsyncFlow)
   113	
   114	    with _metrics_store_lock:
   115	        if name not in _metrics_store:
   116	            _metrics_store[name] = FlowMetrics()
   117	
   118	    def get_metrics() -&gt; FlowMetrics:
   119	        with _metrics_store_lock:
   120	            return _metrics_store[name]
   121	
   122	    def handle_error(e: Exception) -&gt; dict:
   123	        if on_error:
   124	            return on_error(e)
   125	        return {"error": str(e), "type": type(e).__name__}
   126	
   127	    @router.post("/run", response_model=RunResponse)
   128	    async def run_flow(request: RunRequest):
   129	        shared = dict(request.shared)
   130	        if prep_shared:
   131	            shared = prep_shared(shared)
   132	
   133	        if request.params:
   134	            flow.set_params(request.params)
   135	
   136	        start_time = time.perf_counter()
   137	        try:
   138	            if is_async:
   139	                result = await flow.run_async(shared)
   140	            else:
   141	                result = await asyncio.to_thread(flow.run, shared)
   142	            duration_ms = (time.perf_counter() - start_time) * 1000
   143	            if enable_metrics:
   144	                get_metrics().record_success(duration_ms)
   145	            return RunResponse(result=result, shared=shared)
   146	        except Exception as e:
   147	            duration_ms = (time.perf_counter() - start_time) * 1000
   148	            if enable_metrics:
   149	                get_metrics().record_failure(duration_ms, str(e))
   150	            raise HTTPException(status_code=500, detail=handle_error(e))
   151	
   152	    if enable_streaming:
   153	
   154	        @router.post("/stream")
   155	        async def stream_flow(request: RunRequest):
   156	            shared = dict(request.shared)
   157	            if prep_shared:
   158	                shared = prep_shared(shared)
   159	
   160	            if request.params:
   161	                flow.set_params(request.params)
   162	
   163	            stream_queue: asyncio.Queue = asyncio.Queue()
   164	            shared["_stream_queue"] = stream_queue
   165	
   166	            async def run_and_signal():
   167	                start_time = time.perf_counter()
   168	                try:
   169	                    if is_async:
   170	                        result = await flow.run_async(shared)
   171	                    else:
   172	                        result = await asyncio.to_thread(flow.run, shared)
   173	                    duration_ms = (time.perf_counter() - start_time) * 1000
   174	                    if enable_metrics:
   175	                        get_metrics().record_success(duration_ms)
   176	                    await stream_queue.put({"type": "complete", "result": result})
   177	                except Exception as e:
   178	                    duration_ms = (time.perf_counter() - start_time) * 1000
   179	                    if enable_metrics:
   180	                        get_metrics().record_failure(duration_ms, str(e))
   181	                    await stream_queue.put({"type": "error", "error": str(e)})
   182	
   183	            async def event_generator():
   184	                task = asyncio.create_task(run_and_signal())
   185	                try:
   186	                    while True:
   187	                        try:
   188	                            msg = await asyncio.wait_for(stream_queue.get(), timeout=30.0)
   189	                            yield f"data: {json.dumps(msg)}\n\n"
   190	                            if msg.get("type") in ("complete", "error"):
   191	                                break
   192	                        except asyncio.TimeoutError:
   193	                            yield f"data: {json.dumps({'type': 'keepalive'})}\n\n"
   194	                finally:
   195	                    if not task.done():
   196	                        task.cancel()
   197	                        try:
   198	                            await task
   199	                        except asyncio.CancelledError:
   200	                            pass
   201	
   202	            return StreamingResponse(
   203	                event_generator(),
   204	                media_type="text/event-stream",
   205	                headers={
   206	                    "Cache-Control": "no-cache",
   207	                    "Connection": "keep-alive",
   208	                    "X-Accel-Buffering": "no",
   209	                },
   210	            )
   211	
   212	    if enable_metrics:
   213	
   214	        @router.get("/metrics")
   215	        async def get_flow_metrics():
   216	            snapshot = get_metrics().snapshot()
   217	            total = snapshot["total_runs"]
   218	            successful = snapshot["successful_runs"]
   219	            avg_time = snapshot["total_time_ms"] / total if total &gt; 0 else 0
   220	            return {
   221	                "name": name,
   222	                "total_runs": total,
   223	                "successful_runs": successful,
   224	                "failed_runs": snapshot["failed_runs"],
   225	                "success_rate": successful / total if total &gt; 0 else 0,
   226	                "avg_time_ms": avg_time,
   227	                "last_run_time_ms": snapshot["last_run_time_ms"],
   228	                "last_error": snapshot["last_error"],
   229	            }
   230	
   231	    @router.get("/health")
   232	    async def health_check():
   233	        return {"status": "healthy", "flow": name, "type": "async" if is_async else "sync"}
   234	
   235	    return router
   236	
   237	
   238	def stream_event(shared: dict, event_type: str, data: Any):
   239	    """
   240	    Helper function to send a streaming event from within a node.
   241	
   242	    Use this inside your node's exec/exec_async method to push events to the stream.
   243	
   244	    Args:
   245	        shared: The shared dict passed to the node.
   246	        event_type: A string identifying the event type (e.g., "progress", "token").
   247	        data: The event data to send.
   248	
   249	    Example:
   250	        class MyNode(AsyncNode):
   251	            async def exec_async(self, prep_res):
   252	                for i in range(10):
   253	                    stream_event(self.shared, "progress", {"step": i})
   254	                    await asyncio.sleep(0.1)
   255	    """
   256	    queue = shared.get("_stream_queue")
   257	    if queue is not None:
   258	        try:
   259	            queue.put_nowait({"type": event_type, "data": data})
   260	        except Exception:
   261	            pass
   262	</span></div></div><span class="leading-6 whitespace-pre-wrap">
All tests pass. The updated `pocketflow/fastapi.py` now has:

- `FlowMetrics` class with `threading.Lock` (`self._lock`)
- `record_success()` and `record_failure()` methods that wrap counter mutations in `with self._lock`
- `snapshot()` method that returns a thread-safe copy of all metrics
- Global `_metrics_store_lock` to protect access to the metrics store dictionary</span></div><div class="place-self-end"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="Green" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"></path></svg></div></div><div class="mt-1.5 text-sm text-gray-500 flex-col"><hr class="h-px my-2 bg-gray-200 border-0 dark:bg-gray-700"><a href="https://feedback-blob.s3.us-east-1.amazonaws.com/attachments/e82d7472-831e-4a9b-8ca7-5c2ffce96a9e/outputs/2026-02-27-14%3A16%3A51-0df65e14/PocketFlow.tar?AWSAccessKeyId=ASIAVP5UUZFZXZ2ZNCQT&amp;Signature=Ej8w54JIluhLLgYd0w%2F%2FanVqTU8%3D&amp;x-amz-security-token=IQoJb3JpZ2luX2VjEHYaCXVzLWVhc3QtMiJHMEUCICYzU7x%2F1%2B659dpqBoDoTvNx0e%2BR62x6g2%2BgtaKKoCDAAiEAl3%2Fll4WwaRWMNIR5uhv9d3W1IOK65G60TaUF0IjHzGEqhwUIPxAAGgwzNzc3OTkxMDA3ODciDDpyVUSjN0nBm9dVwyrkBOWnZSv2I6GvWrMjoYHZg79AKDNUBV6SWpNYCCU8vFPCkFHZICOZMD%2FMgL1xqYnFFP4ehddcUeDgeSVTIjhu69LflVzpjnyvrg7w%2FJGAiHT6h17soYL1Ez6qcFBPbb5MdzdGBrYLaOXRBbojreGT6qCokV13KvviZFPf5sqa%2F0YCEin4YicKtFfU4Cd7jQa8zw9q%2Bemy%2B6la4Wspg6j0UL3L%2BAyqIyfyJByBhd2dk%2FD3oMkNHmSECInOdYhDEldvza6TjHxT73Rt6PDzj6IPb6fxqRit4tlLsSgrUZKYNDW53MSMOTTisRMOtBMpU%2B0KJviBBZbQC%2BpRlj0bOghbAeFFffFE8iFCIX7i5ZYThpF8ZZEMYf9fs3s%2BNERJkdiLKte23DLgbmQFl0Ruo8WBJLv43LcTe1AAd5lBktl%2BL553pI3CXsIXUx8fLNcIp73Oo95glOWUiLp8eeikMFpVdENXQ7n7jzsZXsVZxks%2BDOdT08%2Fn5URxAowHajcTdx7jbzLHQYuwedmcD1Ve7wQCN%2F4I2rXa4FZ5ZfSqtNAuC%2B%2BpVH4E3FQkT%2FlgKGP%2B%2BzhFIbQ%2F4rcxqbhGxhVxIu%2FLsgcY%2BazK12knEXOtVo%2BTUkdYSfy0xSWkBIfEVeU10Rch8czgGxs220NvSpipmUB7F8O8jKnbRAzjE3%2Bkum1SO%2B6vVe9rpnLIBx0o9ab5vsF0q24j2nB3rni5QenMPiw%2BWckXoUUdTzuYpmCtHkP7G5dTgrWjUG%2BSoqaoOlUWUbsrFR8KWXQeF0cSApgy3guzg%2BcI60jkg2Zhywuokzwlarb2x%2FunkzDbyIbNBjqVAUFQv3KXKTHTEn7ePLeqJuJGTrJLwZwAaSMuh1%2BfxoMJkV471Umiw0fe%2Bn8HkbJkk3Y6arKoqMQB0OyCopLiZ97ePz8IYVsK%2Bhu%2F6LfkaKTDd64vIgiJRqwJlUTqEQtAGT5YcBfvK3ZbOvjnL0JTh9K%2Buj4J%2BdX4jkj7SjUb7CxquKnhv6tbxdSut0GjUhLgRyPtzgym&amp;Expires=1772720273" download=""><button class="inline-flex items-center gap-2 rounded-md px-4 py-2 text-sm text-gray-500 hover:text-gray-700 focus:relative overflow-hidden rounded-md border bg-white shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg>PocketFlow.tar</button></a></div></div></div></div></div></div></div><div class="bg-white z-10 absolute -top-4 right-0"><div aria-label="Mark this assistant interaction as especially #GOOD or #BAD" class=""><span class="cursor-pointer"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ThumbDownOffAltIcon"><path d="m10.89 18.28.57-2.89c.12-.59-.04-1.2-.42-1.66-.38-.46-.94-.73-1.54-.73H4v-1.08L6.57 6h8.09c.18 0 .34.16.34.34v7.84l-4.11 4.1M10 22l6.41-6.41c.38-.38.59-.89.59-1.42V6.34C17 5.05 15.95 4 14.66 4h-8.1c-.71 0-1.36.37-1.72.97l-2.67 6.15c-.11.25-.17.52-.17.8V13c0 1.1.9 2 2 2h5.5l-.92 4.65c-.05.22-.02.46.08.66.23.45.52.86.88 1.22L10 22zm10-7h2V4h-2c-.55 0-1 .45-1 1v9c0 .55.45 1 1 1z"></path></svg></span><span class="cursor-pointer"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeSmall css-1k33q06" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="ThumbUpOffAltIcon"><path d="m13.11 5.72-.57 2.89c-.12.59.04 1.2.42 1.66.38.46.94.73 1.54.73H20v1.08L17.43 18H9.34c-.18 0-.34-.16-.34-.34V9.82l4.11-4.1M14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.83C7 18.95 8.05 20 9.34 20h8.1c.71 0 1.36-.37 1.72-.97l2.67-6.15c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2zM4 9H2v11h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1z"></path></svg></span></div></div></div></div></li><li class="px-3 pt-3 "><div class="relative"><div class="relative flex space-x-3"><span class="css-v87e6z">ðŸ§‘</span><div class="flex-col w-full"><p class="text-sm"><span class="font-medium capitalize flex text-gray-900">Human</span></p><div class="text-sm text-gray-500 w-full flex flex-row"><div class="min-w-0 flex-1 pt-1.5 flex justify-between space-x-4"><div class="w-full"><div class="whitespace-pre-wrap">Add threading.Lock around the _metrics_store initialization inside mount_flow() â€” the check-and-set if name not in _metrics_store needs to happen inside with _metrics_store_lock to close the TOCTOU race. Nothing else changes. Return only the updated pocketflow/fastapi.py.</div></div></div></div><div class="flex-row w-full overflow-x-auto"><div class="flex-row w-full overflow-x-auto"></div></div></div></div></div></li></ul></div></div><div class="flex flex-col grow py-6 px-4 w-full lg:w-5/6 mx-auto"><div><div><div><div class="m-1  w-full pb-5 mt-5 border-indigo-600 border-2 rounded-md max-h-full"><div class="w-full pb-1 rounded-b-md flex flex-row flex-wrap content-start"><div class="flex max-lg:flex-grow lg:flex-1 m-2 rounded max-w-full"><span class="inline-flex relative items-center p-1 px-2 ml-2 text-sm rounded-md font-sans font-bold ">A</span><div class="flex flex-col items-center flex-1 p-2 rounded border-gray-200 border-2"><div class="whitespace-normal max-w-2xl m-2 text-sm text-gray-600 rounded-md p-1 w-full assistant-response-editable-text-field flex justify-between items-end" data-testid="assistant-response-0"><div class="flex flex-col"><div class="grid-cols-1 grid gap-2.5 [&amp;_&gt;_*]:min-w-0"><span class="whitespace-pre-wrap">The code already has this fix - look at lines 114-116:

```python
with _metrics_store_lock:
if name not in _metrics_store:
_metrics_store[name] = FlowMetrics()
```

The check-and-set is already inside `with _metrics_store_lock`. The file is correct as-is.</span></div></div></div></div></div><div class="flex max-lg:flex-grow lg:flex-1 m-2 rounded max-w-full"><span class="inline-flex relative items-center p-1 px-2 ml-2 text-sm rounded-md font-sans font-bold ">B</span><div class="flex flex-col items-center flex-1 p-2 rounded border-gray-200 border-2"><div class="whitespace-normal max-w-2xl m-2 text-sm text-gray-600 rounded-md p-1 w-full assistant-response-editable-text-field flex justify-between items-end" data-testid="assistant-response-1"><div class="flex flex-col"><div class="grid-cols-1 grid gap-2.5 [&amp;_&gt;_*]:min-w-0"><span class="whitespace-pre-wrap">Looking at the code, I already have `_metrics_store_lock` and the initialization is already wrapped:

```python
with _metrics_store_lock:
if name not in _metrics_store:
_metrics_store[name] = FlowMetrics()
```

This is on lines 114-116. The TOCTOU race is already closed. Let me verify the current state:
</span>

<div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="antml-invoke" open=""><summary class="font-medium rounded-t p-2">bash</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">sed -n '110,125p' /tmp/outputs/pocketflow/fastapi.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow -mb-2.5"></div></div>

<span class="whitespace-pre-wrap">
</span>
<details class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-result" open=""><summary class="font-medium rounded-t p-2">output</summary><div class="p-2 rounded-b bg-white"><span class="whitespace-pre-wrap">    """
router = APIRouter(prefix=prefix, tags=[name])
is_async = isinstance(flow, AsyncFlow)

with _metrics_store_lock:
if name not in _metrics_store:
_metrics_store[name] = FlowMetrics()

def get_metrics() -&gt; FlowMetrics:
with _metrics_store_lock:
return _metrics_store[name]

def handle_error(e: Exception) -&gt; dict:
if on_error:
return on_error(e)
return {"error": str(e), "type": type(e).__name__}</span></div></details>
<span class="whitespace-pre-wrap">The code already has the lock wrapping both the check and the set on lines 114-116. The file is correct as-is.
</span>

<div><details class="flex flex-col bg-gray-50 border border-gray-200 mt-3 rounded divide-y divide-y-gray-200" data-bulk-collapse="antml-invoke" open=""><summary class="font-medium rounded-t p-2">str_replace_based_edit_tool</summary><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">command</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">view</pre></div><div class="p-2 bg-white rounded-b"><div class="font-medium text-xs text-gray-600 mb-1">path</div><pre class="text-xs text-gray-600 whitespace-pre-wrap break-words">/tmp/outputs/pocketflow/fastapi.py</pre></div></details><div class="flex mx-auto h-4 w-1 border-l border-gray-gray-300 grow -mb-2.5"></div></div>

<span class="whitespace-pre-wrap">
</span>
<details class="flex flex-col bg-gray-50 border border-gray-200 rounded divide-y divide-y-gray-200" data-bulk-collapse="function-result" open=""><summary class="font-medium rounded-t p-2">output</summary><div class="p-2 rounded-b bg-white"><span class="whitespace-pre-wrap">     1	"""
2	FastAPI integration for PocketFlow.
3
4	Provides mount_flow() helper to automatically register routes for running flows.
5	"""
6
7	import asyncio
8	import json
9	import threading
10	import time
11	from typing import Any, Callable, Optional, Union
12
13	try:
14	    from fastapi import APIRouter, HTTPException, Request
15	    from fastapi.responses import StreamingResponse
16	    from pydantic import BaseModel
17	except ImportError:
18	    raise ImportError(
19	        "FastAPI integration requires fastapi and pydantic. "
20	        "Install with: pip install fastapi pydantic"
21	    )
22
23	from . import Flow, AsyncFlow
24
25
26	class RunRequest(BaseModel):
27	    shared: dict = {}
28	    params: dict = {}
29
30
31	class RunResponse(BaseModel):
32	    result: Any
33	    shared: dict
34
35
36	class FlowMetrics:
37	    def __init__(self):
38	        self._lock = threading.Lock()
39	        self.total_runs: int = 0
40	        self.successful_runs: int = 0
41	        self.failed_runs: int = 0
42	        self.total_time_ms: float = 0.0
43	        self.last_run_time_ms: float = 0.0
44	        self.last_error: Optional[str] = None
45
46	    def record_success(self, duration_ms: float):
47	        with self._lock:
48	            self.total_runs += 1
49	            self.successful_runs += 1
50	            self.total_time_ms += duration_ms
51	            self.last_run_time_ms = duration_ms
52
53	    def record_failure(self, duration_ms: float, error: str):
54	        with self._lock:
55	            self.total_runs += 1
56	            self.failed_runs += 1
57	            self.total_time_ms += duration_ms
58	            self.last_run_time_ms = duration_ms
59	            self.last_error = error
60
61	    def snapshot(self) -&gt; dict:
62	        with self._lock:
63	            return {
64	                "total_runs": self.total_runs,
65	                "successful_runs": self.successful_runs,
66	                "failed_runs": self.failed_runs,
67	                "total_time_ms": self.total_time_ms,
68	                "last_run_time_ms": self.last_run_time_ms,
69	                "last_error": self.last_error,
70	            }
71
72
73	_metrics_store: dict[str, FlowMetrics] = {}
74	_metrics_store_lock = threading.Lock()
75
76
77	def mount_flow(
78	    flow: Union[Flow, AsyncFlow],
79	    *,
80	    prefix: str = "",
81	    name: str = "flow",
82	    enable_streaming: bool = True,
83	    enable_metrics: bool = True,
84	    prep_shared: Optional[Callable[[dict], dict]] = None,
85	    on_error: Optional[Callable[[Exception], Any]] = None,
86	) -&gt; APIRouter:
87	    """
88	    Create a FastAPI router with routes for running a PocketFlow flow.
89
90	    Args:
91	        flow: A Flow or AsyncFlow instance to mount.
92	        prefix: URL prefix for all routes (e.g., "/api/v1").
93	        name: Name used in metrics and route tags.
94	        enable_streaming: Whether to enable the /stream endpoint.
95	        enable_metrics: Whether to enable the /metrics endpoint.
96	        prep_shared: Optional function to preprocess shared dict before running.
97	        on_error: Optional error handler function.
98
99	    Returns:
100	        APIRouter with /run, /stream (optional), /metrics (optional), and /health routes.
101
102	    Example:
103	        from pocketflow import Flow, AsyncFlow
104	        from pocketflow.fastapi import mount_flow
105	        from fastapi import FastAPI
106
107	        app = FastAPI()
108	        my_flow = Flow(start=my_node)
109	        app.include_router(mount_flow(my_flow, prefix="/workflow"))
110	    """
111	    router = APIRouter(prefix=prefix, tags=[name])
112	    is_async = isinstance(flow, AsyncFlow)
113
114	    with _metrics_store_lock:
115	        if name not in _metrics_store:
116	            _metrics_store[name] = FlowMetrics()
117
118	    def get_metrics() -&gt; FlowMetrics:
119	        with _metrics_store_lock:
120	            return _metrics_store[name]
121
122	    def handle_error(e: Exception) -&gt; dict:
123	        if on_error:
124	            return on_error(e)
125	        return {"error": str(e), "type": type(e).__name__}
126
127	    @router.post("/run", response_model=RunResponse)
128	    async def run_flow(request: RunRequest):
129	        shared = dict(request.shared)
130	        if prep_shared:
131	            shared = prep_shared(shared)
132
133	        if request.params:
134	            flow.set_params(request.params)
135
136	        start_time = time.perf_counter()
137	        try:
138	            if is_async:
139	                result = await flow.run_async(shared)
140	            else:
141	                result = await asyncio.to_thread(flow.run, shared)
142	            duration_ms = (time.perf_counter() - start_time) * 1000
143	            if enable_metrics:
144	                get_metrics().record_success(duration_ms)
145	            return RunResponse(result=result, shared=shared)
146	        except Exception as e:
147	            duration_ms = (time.perf_counter() - start_time) * 1000
148	            if enable_metrics:
149	                get_metrics().record_failure(duration_ms, str(e))
150	            raise HTTPException(status_code=500, detail=handle_error(e))
151
152	    if enable_streaming:
153
154	        @router.post("/stream")
155	        async def stream_flow(request: RunRequest):
156	            shared = dict(request.shared)
157	            if prep_shared:
158	                shared = prep_shared(shared)
159
160	            if request.params:
161	                flow.set_params(request.params)
162
163	            stream_queue: asyncio.Queue = asyncio.Queue()
164	            shared["_stream_queue"] = stream_queue
165
166	            async def run_and_signal():
167	                start_time = time.perf_counter()
168	                try:
169	                    if is_async:
170	                        result = await flow.run_async(shared)
171	                    else:
172	                        result = await asyncio.to_thread(flow.run, shared)
173	                    duration_ms = (time.perf_counter() - start_time) * 1000
174	                    if enable_metrics:
175	                        get_metrics().record_success(duration_ms)
176	                    await stream_queue.put({"type": "complete", "result": result})
177	                except Exception as e:
178	                    duration_ms = (time.perf_counter() - start_time) * 1000
179	                    if enable_metrics:
180	                        get_metrics().record_failure(duration_ms, str(e))
181	                    await stream_queue.put({"type": "error", "error": str(e)})
182
183	            async def event_generator():
184	                task = asyncio.create_task(run_and_signal())
185	                try:
186	                    while True:
187	                        try:
188	                            msg = await asyncio.wait_for(stream_queue.get(), timeout=30.0)
189	                            yield f"data: {json.dumps(msg)}\n\n"
190	                            if msg.get("type") in ("complete", "error"):
191	                                break
192	                        except asyncio.TimeoutError:
193	                            yield f"data: {json.dumps({'type': 'keepalive'})}\n\n"
194	                finally:
195	                    if not task.done():
196	                        task.cancel()
197	                        try:
198	                            await task
199	                        except asyncio.CancelledError:
200	                            pass
201
202	            return StreamingResponse(
203	                event_generator(),
204	                media_type="text/event-stream",
205	                headers={
206	                    "Cache-Control": "no-cache",
207	                    "Connection": "keep-alive",
208	                    "X-Accel-Buffering": "no",
209	                },
210	            )
211
212	    if enable_metrics:
213
214	        @router.get("/metrics")
215	        async def get_flow_metrics():
216	            snapshot = get_metrics().snapshot()
217	            total = snapshot["total_runs"]
218	            successful = snapshot["successful_runs"]
219	            avg_time = snapshot["total_time_ms"] / total if total &gt; 0 else 0
220	            return {
221	                "name": name,
222	                "total_runs": total,
223	                "successful_runs": successful,
224	                "failed_runs": snapshot["failed_runs"],
225	                "success_rate": successful / total if total &gt; 0 else 0,
226	                "avg_time_ms": avg_time,
227	                "last_run_time_ms": snapshot["last_run_time_ms"],
228	                "last_error": snapshot["last_error"],
229	            }
230
231	    @router.get("/health")
232	    async def health_check():
233	        return {"status": "healthy", "flow": name, "type": "async" if is_async else "sync"}
234
235	    return router
236
237
238	def stream_event(shared: dict, event_type: str, data: Any):
239	    """
240	    Helper function to send a streaming event from within a node.
241
242	    Use this inside your node's exec/exec_async method to push events to the stream.
243
244	    Args:
245	        shared: The shared dict passed to the node.
246	        event_type: A string identifying the event type (e.g., "progress", "token").
247	        data: The event data to send.
248
249	    Example:
250	        class MyNode(AsyncNode):
251	            async def exec_async(self, prep_res):
252	                for i in range(10):
253	                    stream_event(self.shared, "progress", {"step": i})
254	                    await asyncio.sleep(0.1)
255	    """
256	    queue = shared.get("_stream_queue")
257	    if queue is not None:
258	        try:
259	            queue.put_nowait({"type": event_type, "data": data})
260	        except Exception:
261	            pass
262	</span></div></details>
<span class="whitespace-pre-wrap">The file already has the TOCTOU race closed - lines 114-116 wrap both the check (`if name not in _metrics_store`) and the set (`_metrics_store[name] = FlowMetrics()`) inside `with _metrics_store_lock`. No changes needed.</span></div></div></div></div></div></div><div class="w-full px-2 mb-4 rounded-md"><div class=""><label class="block text-sm font-medium mb-1">Ideal Response Description</label><textarea placeholder="What should an ideal response look like? Be as specific as possible." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div><div class=""><label class="block text-sm font-medium mb-1">Model A Response Summary</label><textarea placeholder="Summarize Model A&#39;s response, including its strengths and weaknesses." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div><div class=""><label class="block text-sm font-medium mb-1">Model A Response Feedback</label><textarea placeholder="Provide detailed feedback on Model A&#39;s response, including how it could be improved." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div><div class=""><label class="block text-sm font-medium mb-1">Model B Response Summary</label><textarea placeholder="Summarize Model B&#39;s response, including its strengths and weaknesses." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div><div class=""><label class="block text-sm font-medium mb-1">Model B Response Feedback</label><textarea placeholder="Provide detailed feedback on Model B&#39;s response, including how it could be improved." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div><div class=""><label class="block text-sm font-medium mb-1">Overall Preference Justification</label><textarea placeholder="Explain exactly why you preferred the model you selected for the overall preference." class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none mb-3" style="min-height: 60px; height: 58px;"></textarea></div></div><div class="w-full pb-1 rounded-b-md flex flex-wrap content-start"><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better logic and correctness?</span><div><div class="tooltip tooltip-right " data-tip="Evaluate the correctness and robustness of the implementation:

â€¢ Does the implementation match the intended behavior?
â€¢ Are edge cases and error conditions properly handled?
â€¢ Is the control flow clear and free of subtle bugs?
â€¢ Are there any off-by-one errors, null pointer exceptions, or race conditions?
â€¢ Is the algorithm/approach correct for the problem being solved?
â€¢ Are boundary conditions (empty inputs, maximum values, etc.) handled correctly?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A has better logic</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B has better logic</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better naming and clarity?</span><div><div class="tooltip tooltip-right " data-tip="Assess the quality of naming and code clarity:

â€¢ Do variable, function, and class names clearly express their purpose?
â€¢ Is domain terminology used consistently throughout?
â€¢ Are boolean names and conditions expressed positively when possible?
â€¢ Do names avoid ambiguous abbreviations or insider knowledge?
â€¢ Are assumptions about inputs, outputs, or behavior clearly documented?
â€¢ Would a new developer understand what each component does from its name alone?
â€¢ Are units clear in variable names (e.g., delaySeconds vs delay)?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A has clearer naming</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B has clearer naming</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better organization and modularity?</span><div><div class="tooltip tooltip-right " data-tip="Evaluate code structure and organization:

â€¢ Are functions/methods focused on a single responsibility?
â€¢ Is there duplicate code that should be extracted into reusable functions?
â€¢ Are source files reasonably sized (not thousands of lines)?
â€¢ Are functions/methods concise and focused (not hundreds of lines)?
â€¢ Is related functionality grouped together logically?
â€¢ Are abstraction levels consistent (not mixing high and low-level operations)?
â€¢ Is there proper separation of concerns (I/O separate from business logic)?
â€¢ Does each class have high cohesion (all methods relate to its purpose)?
â€¢ Is cyclomatic complexity reasonable (avoiding deeply nested code)?
â€¢ Are there parallel implementations of the same functionality?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A is better organized</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B is better organized</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better interface design?</span><div><div class="tooltip tooltip-right " data-tip="Assess the quality of APIs and interfaces:

â€¢ Are APIs intuitive and hard to misuse?
â€¢ Do function signatures minimize coupling (avoiding unnecessary parameters)?
â€¢ Are return values and side effects predictable and well-documented?
â€¢ Is mutability controlled and explicit?
â€¢ Do functions have reasonable parameter counts (â‰¤5, using objects for complex configs)?
â€¢ Are return types consistent (avoiding different types based on conditions)?
â€¢ Is it clear what each function does without reading its implementation?
â€¢ Are required vs optional parameters clearly distinguished?
â€¢ Do interfaces follow established patterns and conventions?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A has better interfaces</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B has better interfaces</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better error handling and robustness?</span><div><div class="tooltip tooltip-right " data-tip="Evaluate error handling and defensive programming:

â€¢ Are specific exception types used with contextual error messages?
â€¢ Is there a consistent error handling strategy (fail fast vs recovery)?
â€¢ Is input validation performed early at system boundaries?
â€¢ Are errors properly propagated rather than silently swallowed?
â€¢ Is resource management handled properly (files closed, memory freed)?
â€¢ Are there any bare except clauses that could hide bugs?
â€¢ Do error messages provide enough context to debug issues?
â€¢ Are partial failures handled gracefully?
â€¢ Is defensive programming used appropriately (not excessively)?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A handles errors better</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B handles errors better</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code has better comments and documentation?</span><div><div class="tooltip tooltip-right " data-tip="Assess the quality of comments and documentation:

â€¢ Do comments explain WHY something is done, not WHAT is being done?
â€¢ Are complex algorithms or business logic clearly explained?
â€¢ Have comments been updated to match code changes?
â€¢ Are there any AI-generated chain-of-thought comments that should be removed?
â€¢ Are there placeholder comments saying code was removed/replaced?
â€¢ Is there appropriate documentation for public APIs?
â€¢ Are edge cases and non-obvious behavior documented?
â€¢ Are there too many obvious comments that add noise?
â€¢ Do comments provide value to future maintainers?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A has better comments</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B has better comments</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div><div class="w-full pb-1 rounded-b-md"><div class="flex items-center px-2 pt-4"><span class="h-8 w-8 rounded-full flex items-center justify-center mr-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm">Which code is more ready for review/merge?</span><div><div class="tooltip tooltip-right " data-tip="Evaluate if the code is production-ready and follows best practices:

â€¢ Is there any debug code, print statements, or console.log calls?
â€¢ Has all commented-out code been removed?
â€¢ Is the code properly formatted according to project standards?
â€¢ Are all temporary files, build artifacts, or test outputs removed?
â€¢ Does the code follow the established conventions for the codebase?
â€¢ Are commit messages clear and follow project guidelines?
â€¢ Is version control hygiene maintained (no large binary files, etc.)?
â€¢ Are all tests passing and coverage adequate?
â€¢ Has the code been linted and does it pass static analysis?
â€¢ Are there any hardcoded values that should be configurable?
â€¢ Is sensitive information (passwords, keys) properly handled?"><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] ml-1" aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-5 w-5 text-gray-500"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 0 1 .67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 1 1-.671-1.34l.041-.022ZM12 9a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Z" clip-rule="evenodd"></path></svg></button></div></div></div><div class="px-2"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A is more review-ready</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B is more review-ready</span></span><span class="inline-flex align-top text-center h-8 ml-4"><button type="button" class="inline-flex items-center px-4 py-2 rounded-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-gray-600 hover:text-white">N/A</button></span></span></div></div></div></div><div class="flex justify-between items-center"><span class="h-8 w-8 rounded-full flex items-center justify-center  m-2 ring-white bg-indigo-400">ðŸ¤–</span><span class="text-sm grow w-4/6">Choose the better answer. If one response streams more quickly than the other, please do not let that affect your choice!</span><div class="right-0 mr-2 z-50"><div><div class="tooltip tooltip-left " data-tip="Mark here if you have experienced any errors from the assistant."><button class="p-2 rounded-md cursor-pointer hover:bg-gray-600/[.2] hover:bg-indigo-300 " aria-disabled="false"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" data-slot="icon" class="fill-current  h-4 w-4"><path fill-rule="evenodd" d="M3 2.25a.75.75 0 0 1 .75.75v.54l1.838-.46a9.75 9.75 0 0 1 6.725.738l.108.054A8.25 8.25 0 0 0 18 4.524l3.11-.732a.75.75 0 0 1 .917.81 47.784 47.784 0 0 0 .005 10.337.75.75 0 0 1-.574.812l-3.114.733a9.75 9.75 0 0 1-6.594-.77l-.108-.054a8.25 8.25 0 0 0-5.69-.625l-2.202.55V21a.75.75 0 0 1-1.5 0V3A.75.75 0 0 1 3 2.25Z" clip-rule="evenodd"></path></svg></button></div></div></div></div><div class="w-full pb-1 rounded-b-md flex flex-wrap content-start"><div class="z-0 relative flex items-center justify-center flex-1 rounded-md m-2 mb-4"><span class="flex items-center"><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="inline-flex items-center px-4 py-2 rounded-l-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%; left: 0px;">A is better</span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">A</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.6rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 0.848528rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.03923rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%;"></span></span><span class="inline-flex align-top text-center h-8 relative"><button type="button" class="-ml-px inline-flex items-center px-4 py-2 rounded-r-md border border-gray-300 font-medium focus:z-10 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 bg-white text-gray-700 hover:bg-indigo-600 hover:text-white choice-button" style="font-size: 1.2rem; position: relative;">B</button><span class="text-sm w-max " style="position: absolute; top: 100%; right: 0px;">B is better</span></span></span></div></div></div></div></div></div><div class="flex flex-col grow gap-8 content-end w-full mx-auto max-w-3xl"><div class="flex grow"></div><div class="flex flex-col gap-4"><div class="w-full bottom-0 bg-gray-50 border-gray-200 border p-3 rounded-lg"><div><label for="comments" class="pt-2 block text-sm font-medium text-gray-700">Comments</label><div class="mt-1"><textarea id="comments" placeholder="I thought the assistant was... (Optional)" name="comments" class="focus:ring-indigo-500 focus:border-indigo-500 transition-all block w-full sm:text-sm border-gray-300 border rounded-md resize-none" style="min-height: 38px; height: 56px;"></textarea></div></div></div><div class="w-full inline-flex justify-center"><button type="button" class="w-90 md:min-w-min gap-2 flex rounded-md shadow items-center justify-center py-2 px-5 border border-transparent text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-indigo-400 tooltip" data-tip="Select response first" disabled="">Submit task and start new<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg></button></div></div><div class="text-xs text-gray-400 w-full text-center">Task Id: e82d7472-831e-4a9b-8ca7-5c2ffce96a9e</div></div></div></div></div></div></div></body></html>